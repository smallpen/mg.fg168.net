name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PHP_VERSION: 8.2
  NODE_VERSION: 18

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: è¨­å®š PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql, gd
          coverage: xdebug
          
      - name: å¿«å– Composer ä¾è³´
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache/files
          key: dependencies-composer-${{ hashFiles('composer.lock') }}
          
      - name: å®‰è£ Composer ä¾è³´
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
        
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: å®‰è£ NPM ä¾è³´
        run: npm ci
        
      - name: ç·¨è­¯å‰ç«¯è³‡æº
        run: npm run build
        
      - name: è¤‡è£½ç’°å¢ƒè¨­å®šæª”
        run: cp .env.example .env
        
      - name: ç”Ÿæˆæ‡‰ç”¨ç¨‹å¼é‡‘é‘°
        run: php artisan key:generate
        
      - name: å»ºç«‹ SQLite è³‡æ–™åº«
        run: |
          mkdir -p database
          touch database/database.sqlite
          
      - name: åŸ·è¡Œè³‡æ–™åº«é·ç§»
        run: php artisan migrate --force
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          
      - name: åŸ·è¡Œè³‡æ–™åº«ç¨®å­
        run: php artisan db:seed --force
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          
      # PHP ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
      - name: PHP ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (PHP CS Fixer)
        run: |
          if [ ! -f .php-cs-fixer.php ]; then
            echo "å»ºç«‹ PHP CS Fixer è¨­å®šæª”..."
            cat > .php-cs-fixer.php << 'EOF'
          <?php
          
          $finder = PhpCsFixer\Finder::create()
              ->in(__DIR__)
              ->exclude(['bootstrap', 'storage', 'vendor'])
              ->name('*.php')
              ->notName('*.blade.php')
              ->ignoreDotFiles(true)
              ->ignoreVCS(true);
          
          return (new PhpCsFixer\Config())
              ->setRules([
                  '@PSR12' => true,
                  'array_syntax' => ['syntax' => 'short'],
                  'ordered_imports' => ['sort_algorithm' => 'alpha'],
                  'no_unused_imports' => true,
                  'not_operator_with_successor_space' => true,
                  'trailing_comma_in_multiline' => true,
                  'phpdoc_scalar' => true,
                  'unary_operator_spaces' => true,
                  'binary_operator_spaces' => true,
                  'blank_line_before_statement' => [
                      'statements' => ['break', 'continue', 'declare', 'return', 'throw', 'try'],
                  ],
                  'phpdoc_single_line_var_spacing' => true,
                  'phpdoc_var_without_name' => true,
              ])
              ->setFinder($finder);
          EOF
          fi
          ./vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
          
      # PHPStan éœæ…‹åˆ†æ
      - name: PHPStan éœæ…‹åˆ†æ
        run: |
          if [ ! -f phpstan.neon ]; then
            echo "å»ºç«‹ PHPStan è¨­å®šæª”..."
            cat > phpstan.neon << 'EOF'
          parameters:
              level: 5
              paths:
                  - app
                  - config
                  - database
                  - routes
              excludePaths:
                  - app/Console/Kernel.php
                  - app/Exceptions/Handler.php
                  - app/Http/Kernel.php
              ignoreErrors:
                  - '#Call to an undefined method Illuminate\\Database\\Eloquent\\Builder#'
                  - '#Call to an undefined method Illuminate\\Database\\Query\\Builder#'
          EOF
          fi
          ./vendor/bin/phpstan analyse --memory-limit=2G
          
      # Larastan (Laravel å°ˆç”¨çš„ PHPStan)
      - name: Larastan åˆ†æ
        run: |
          if command -v ./vendor/bin/phpstan &> /dev/null; then
            ./vendor/bin/phpstan analyse --configuration=phpstan.neon --memory-limit=2G
          else
            echo "Larastan æœªå®‰è£ï¼Œè·³éåˆ†æ"
          fi
          
      # åŸ·è¡Œæ¸¬è©¦
      - name: åŸ·è¡Œ PHPUnit æ¸¬è©¦
        run: php artisan test --coverage --min=80
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite
          
      # ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
      - name: ä¸Šå‚³è¦†è“‹ç‡å ±å‘Šåˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # å®‰å…¨æ€§æƒæ
  security-scan:
    name: å®‰å…¨æ€§æƒæ
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: è¨­å®š PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          
      - name: å®‰è£ Composer ä¾è³´
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
        
      # Composer å®‰å…¨æ€§æª¢æŸ¥
      - name: Composer å®‰å…¨æ€§æª¢æŸ¥
        run: composer audit
        
      # PHP å®‰å…¨æ€§æª¢æŸ¥
      - name: PHP å®‰å…¨æ€§æª¢æŸ¥
        run: |
          if [ -f ./vendor/bin/security-checker ]; then
            ./vendor/bin/security-checker security:check composer.lock
          else
            echo "Security checker æœªå®‰è£ï¼Œè·³éæª¢æŸ¥"
          fi

  # Docker æ˜ åƒå»ºç½®æ¸¬è©¦
  docker-build:
    name: Docker æ˜ åƒå»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: å»ºç½® Docker æ˜ åƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/php/Dockerfile.prod
          push: false
          tags: laravel-admin:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
  deploy-staging:
    name: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, docker-build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_PORT }}
          script: |
            cd ${{ secrets.STAGING_PATH }}
            
            # å‚™ä»½ç•¶å‰ç‰ˆæœ¬
            if [ -d "backup" ]; then rm -rf backup; fi
            cp -r current backup || true
            
            # æ›´æ–°ç¨‹å¼ç¢¼
            git fetch origin
            git reset --hard origin/develop
            
            # å»ºç½®å’Œéƒ¨ç½²
            docker-compose -f docker-compose.staging.yml down
            docker-compose -f docker-compose.staging.yml build --no-cache
            docker-compose -f docker-compose.staging.yml up -d
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 30
            
            # åŸ·è¡Œè³‡æ–™åº«é·ç§»
            docker-compose -f docker-compose.staging.yml exec -T app php artisan migrate --force
            
            # æ¸…ç†å¿«å–
            docker-compose -f docker-compose.staging.yml exec -T app php artisan config:cache
            docker-compose -f docker-compose.staging.yml exec -T app php artisan route:cache
            docker-compose -f docker-compose.staging.yml exec -T app php artisan view:cache
            docker-compose -f docker-compose.staging.yml exec -T app php artisan queue:restart
            
      - name: æ¸¬è©¦ç’°å¢ƒå¥åº·æª¢æŸ¥
        run: |
          echo "ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•..."
          sleep 60
          
          # æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ˜¯å¦æ­£å¸¸é‹è¡Œ
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_URL }}/health)
          if [ $response -eq 200 ]; then
            echo "âœ… æ¸¬è©¦ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼Œå¥åº·æª¢æŸ¥é€šé"
          else
            echo "âŒ æ¸¬è©¦ç’°å¢ƒå¥åº·æª¢æŸ¥å¤±æ•—ï¼ŒHTTP ç‹€æ…‹ç¢¼: $response"
            exit 1
          fi
          
      - name: é€šçŸ¥éƒ¨ç½²çµæœ
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            æ¸¬è©¦ç’°å¢ƒéƒ¨ç½² ${{ job.status }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            ä½œè€…: ${{ github.actor }}

  # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, docker-build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd ${{ secrets.PRODUCTION_PATH }}
            
            # å»ºç«‹å‚™ä»½
            backup_dir="backups/backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p $backup_dir
            
            # å‚™ä»½è³‡æ–™åº«
            docker-compose -f docker-compose.prod.yml exec -T mysql mysqldump -u root -p$MYSQL_ROOT_PASSWORD laravel_admin > $backup_dir/database.sql
            
            # å‚™ä»½æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆ
            tar -czf $backup_dir/storage.tar.gz storage/
            cp .env $backup_dir/
            
            # æ›´æ–°ç¨‹å¼ç¢¼
            git fetch origin
            git reset --hard origin/main
            
            # é›¶åœæ©Ÿéƒ¨ç½²
            # 1. å»ºç½®æ–°çš„æ˜ åƒ
            docker-compose -f docker-compose.prod.yml build --no-cache app
            
            # 2. å•Ÿå‹•æ–°çš„æ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼ˆä½¿ç”¨ä¸åŒçš„åç¨±ï¼‰
            docker-compose -f docker-compose.prod.yml up -d --scale app=2 app
            
            # 3. ç­‰å¾…æ–°å®¹å™¨æº–å‚™å°±ç·’
            sleep 45
            
            # 4. åŸ·è¡Œè³‡æ–™åº«é·ç§»
            docker-compose -f docker-compose.prod.yml exec -T app php artisan migrate --force
            
            # 5. æ¸…ç†å¿«å–
            docker-compose -f docker-compose.prod.yml exec -T app php artisan config:cache
            docker-compose -f docker-compose.prod.yml exec -T app php artisan route:cache
            docker-compose -f docker-compose.prod.yml exec -T app php artisan view:cache
            docker-compose -f docker-compose.prod.yml exec -T app php artisan queue:restart
            
            # 6. é‡æ–°è¼‰å…¥ Nginx é…ç½®
            docker-compose -f docker-compose.prod.yml exec nginx nginx -s reload
            
            # 7. ç¸®æ¸›åˆ°å–®ä¸€æ‡‰ç”¨ç¨‹å¼å®¹å™¨
            docker-compose -f docker-compose.prod.yml up -d --scale app=1 app
            
            # æ¸…ç†èˆŠçš„æ˜ åƒ
            docker image prune -f
            
      - name: ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
        run: |
          echo "ç­‰å¾…ç”Ÿç”¢ç’°å¢ƒæœå‹™å®Œå…¨å•Ÿå‹•..."
          sleep 90
          
          # å¤šæ¬¡å¥åº·æª¢æŸ¥ç¢ºä¿ç©©å®šæ€§
          for i in {1..5}; do
            echo "ç¬¬ $i æ¬¡å¥åº·æª¢æŸ¥..."
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/health)
            if [ $response -eq 200 ]; then
              echo "âœ… å¥åº·æª¢æŸ¥ $i é€šé"
            else
              echo "âŒ å¥åº·æª¢æŸ¥ $i å¤±æ•—ï¼ŒHTTP ç‹€æ…‹ç¢¼: $response"
              exit 1
            fi
            sleep 10
          done
          
          echo "ğŸ‰ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æˆåŠŸï¼Œæ‰€æœ‰å¥åº·æª¢æŸ¥é€šé"
          
      - name: æ•ˆèƒ½æ¸¬è©¦
        run: |
          echo "åŸ·è¡ŒåŸºæœ¬æ•ˆèƒ½æ¸¬è©¦..."
          
          # ä½¿ç”¨ curl æ¸¬è©¦å›æ‡‰æ™‚é–“
          response_time=$(curl -o /dev/null -s -w "%{time_total}" ${{ secrets.PRODUCTION_URL }})
          echo "é¦–é å›æ‡‰æ™‚é–“: ${response_time}s"
          
          # æª¢æŸ¥å›æ‡‰æ™‚é–“æ˜¯å¦åœ¨å¯æ¥å—ç¯„åœå…§ï¼ˆ3ç§’ï¼‰
          if (( $(echo "$response_time > 3.0" | bc -l) )); then
            echo "âš ï¸ è­¦å‘Šï¼šå›æ‡‰æ™‚é–“è¶…é 3 ç§’"
          else
            echo "âœ… å›æ‡‰æ™‚é–“æ­£å¸¸"
          fi
          
      - name: é€šçŸ¥éƒ¨ç½²çµæœ
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸš€ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½² ${{ job.status }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            ä½œè€…: ${{ github.actor }}
            éƒ¨ç½²æ™‚é–“: ${{ steps.deploy.outputs.time }}

  # éƒ¨ç½²å¾Œç›£æ§
  post-deploy-monitoring:
    name: éƒ¨ç½²å¾Œç›£æ§
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: æŒçºŒç›£æ§
        run: |
          echo "é–‹å§‹éƒ¨ç½²å¾Œç›£æ§..."
          
          # ç›£æ§ 5 åˆ†é˜
          for i in {1..30}; do
            echo "ç›£æ§æª¢æŸ¥ $i/30..."
            
            # æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/health)
            
            if [ $response -eq 200 ]; then
              echo "âœ… æ‡‰ç”¨ç¨‹å¼é‹è¡Œæ­£å¸¸"
            else
              echo "âŒ æ‡‰ç”¨ç¨‹å¼ç•°å¸¸ï¼ŒHTTP ç‹€æ…‹ç¢¼: $response"
              
              # ç™¼é€è­¦å ±
              curl -X POST -H 'Content-type: application/json' \
                --data '{"text":"ğŸš¨ ç”Ÿç”¢ç’°å¢ƒç•°å¸¸ï¼HTTP ç‹€æ…‹ç¢¼: '$response'"}' \
                ${{ secrets.SLACK_WEBHOOK }}
              
              exit 1
            fi
            
            sleep 10
          done
          
          echo "ğŸ‰ éƒ¨ç½²å¾Œç›£æ§å®Œæˆï¼Œç³»çµ±é‹è¡Œç©©å®š"