<?php

namespace App\Livewire\Admin\Settings;

use App\Livewire\Admin\AdminComponent;
use App\Repositories\SettingsRepositoryInterface;
use App\Services\ConfigurationService;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Livewire\Attributes\Computed;
use Livewire\Attributes\On;
use Livewire\WithFileUploads;

/**
 * åˆ†é¡è¨­å®šè¡¨å–®å…ƒä»¶
 * 
 * æä¾›ç‰¹å®šåˆ†é¡çš„æ‰€æœ‰è¨­å®šé …ç›®ç·¨è¼¯ä»‹é¢
 */
class CategorySettingsForm extends AdminComponent
{
    use WithFileUploads;

    /**
     * è¨­å®šåˆ†é¡
     */
    public string $category = '';

    /**
     * è¨­å®šå€¼é™£åˆ—
     */
    public array $values = [];

    /**
     * åŸå§‹å€¼é™£åˆ—ï¼ˆç”¨æ–¼æ¯”è¼ƒè®Šæ›´ï¼‰
     */
    public array $originalValues = [];

    /**
     * é©—è­‰éŒ¯èª¤è¨Šæ¯
     */
    public array $validationErrors = [];

    /**
     * ä¾è³´æª¢æŸ¥çµæœ
     */
    public array $dependencyWarnings = [];

    /**
     * æ­£åœ¨å„²å­˜
     */
    public bool $saving = false;

    /**
     * å•Ÿç”¨è‡ªå‹•å„²å­˜
     */
    public bool $autoSave = false;

    /**
     * è‡ªå‹•å„²å­˜å»¶é²ï¼ˆæ¯«ç§’ï¼‰
     */
    public int $autoSaveDelay = 2000;

    /**
     * ä¸Šå‚³çš„æª”æ¡ˆ
     */
    public array $uploadedFiles = [];

    /**
     * å–å¾—è¨­å®šè³‡æ–™åº«
     */
    protected function getSettingsRepository(): SettingsRepositoryInterface
    {
        return app(SettingsRepositoryInterface::class);
    }

    /**
     * å–å¾—é…ç½®æœå‹™
     */
    protected function getConfigService(): ConfigurationService
    {
        return app(ConfigurationService::class);
    }

    /**
     * å–å¾—åˆ†é¡è¨­å®š
     */
    #[Computed]
    public function categorySettings(): array
    {
        if (empty($this->category)) {
            return [];
        }

        $allSettings = config('system-settings.settings', []);
        $categorySettings = [];

        foreach ($allSettings as $key => $config) {
            if (($config['category'] ?? '') === $this->category) {
                $categorySettings[$key] = $config;
            }
        }

        // æŒ‰ order æ’åº
        uasort($categorySettings, function ($a, $b) {
            return ($a['order'] ?? 999) <=> ($b['order'] ?? 999);
        });

        return $categorySettings;
    }

    /**
     * å–å¾—åˆ†é¡è³‡è¨Š
     */
    #[Computed]
    public function categoryInfo(): array
    {
        $categories = config('system-settings.categories', []);
        return $categories[$this->category] ?? [
            'name' => $this->category,
            'description' => '',
            'icon' => 'cog'
        ];
    }

    /**
     * æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
     */
    #[Computed]
    public function hasChanges(): bool
    {
        foreach ($this->values as $key => $value) {
            if (($this->originalValues[$key] ?? null) !== $value) {
                return true;
            }
        }
        return false;
    }

    /**
     * å–å¾—æ‰€æœ‰é©—è­‰è¦å‰‡
     */
    #[Computed]
    public function validationRules(): array
    {
        $rules = [];
        
        foreach ($this->categorySettings as $key => $config) {
            if (isset($config['validation'])) {
                $fieldName = "values.{$key}";
                
                if (is_string($config['validation'])) {
                    $rules[$fieldName] = $config['validation'];
                } elseif (is_array($config['validation'])) {
                    $rules[$fieldName] = $config['validation'];
                }
            }
        }

        return $rules;
    }

    /**
     * æ›è¼‰å…ƒä»¶
     */
    public function mount(string $category = ''): void
    {
        $this->category = $category;
        $this->loadSettings();
    }

    /**
     * è¼‰å…¥è¨­å®šè³‡æ–™
     */
    public function loadSettings(): void
    {
        if (empty($this->category)) {
            return;
        }

        $this->values = [];
        $this->originalValues = [];

        foreach ($this->categorySettings as $key => $config) {
            $setting = $this->getSettingsRepository()->getSetting($key);
            $value = $setting ? $setting->value : ($config['default'] ?? null);
            
            $this->values[$key] = $value;
            $this->originalValues[$key] = $value;
        }

        $this->checkAllDependencies();
    }

    /**
     * å„²å­˜æ‰€æœ‰è¨­å®š
     */
    public function save(): void
    {
        $this->saving = true;
        $this->resetValidationState();

        try {
            // é©—è­‰æ‰€æœ‰è¨­å®š
            if (!$this->validateAllSettings()) {
                return;
            }

            // æª¢æŸ¥ä¾è³´é—œä¿‚
            $this->checkAllDependencies();

            // è™•ç†æª”æ¡ˆä¸Šå‚³
            $this->handleFileUploads();

            // æ‰¹é‡æ›´æ–°è¨­å®š
            $updatedCount = 0;
            foreach ($this->values as $key => $value) {
                if (($this->originalValues[$key] ?? null) !== $value) {
                    $result = $this->getSettingsRepository()->updateSetting($key, $value);
                    if ($result) {
                        $this->originalValues[$key] = $value;
                        $updatedCount++;
                    }
                }
            }

            if ($updatedCount > 0) {
                $this->dispatch('settings-updated', category: $this->category, count: $updatedCount);
                $this->addFlash('success', "æˆåŠŸæ›´æ–° {$updatedCount} å€‹è¨­å®š");
                
                // è§¸ç™¼é è¦½æ›´æ–°
                $this->dispatch('category-settings-updated', [
                    'category' => $this->category,
                    'settings' => $this->values
                ]);
            } else {
                $this->addFlash('info', 'æ²’æœ‰è¨­å®šéœ€è¦æ›´æ–°');
            }

        } catch (ValidationException $e) {
            $this->validationErrors = $e->validator->errors()->toArray();
            $this->addFlash('error', 'è¨­å®šé©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å€¼');
        } catch (\Exception $e) {
            $this->addFlash('error', "è¨­å®šæ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{$e->getMessage()}");
        } finally {
            $this->saving = false;
        }
    }

    /**
     * é‡è¨­è¡¨å–®
     */
    public function resetForm(): void
    {
        try {
        // è¨˜éŒ„è¡¨å–®é‡ç½®æ“ä½œ
        \Log::info('ğŸ”„ resetForm - æ¨¡æ…‹è¡¨å–®é‡ç½®é–‹å§‹', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
            'modal_component' => static::class,
        ]);
        
        // é‡ç½®æ‰€æœ‰è¡¨å–®æ¬„ä½å’Œæ¨¡æ…‹ç‹€æ…‹
        $this->category = '';
        $this->values = '';
        $this->originalValues = '';
        $this->validationErrors = '';
        $this->dependencyWarnings = '';
        $this->saving = '';
        $this->autoSave = '';
        $this->autoSaveDelay = '';
        $this->uploadedFiles = '';
        $this->showModal = false;
        $this->isOpen = false;
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€è¡¨å–®é‡ç½®å®Œæˆäº‹ä»¶
        $this->dispatch('resetForm-completed');
        $this->dispatch('modal-form-reset');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… resetForm - æ¨¡æ…‹è¡¨å–®é‡ç½®å®Œæˆ');

        } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'resetForm',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * é‡è¨­ç‰¹å®šè¨­å®šç‚ºé è¨­å€¼
     */
    public function resetSetting(string $key): void
    {
        if (!isset($this->categorySettings[$key])) {
            return;
        }

        try {
            $result = $this->getSettingsRepository()->resetSetting($key);
            
            if ($result) {
                $setting = $this->getSettingsRepository()->getSetting($key);
                $this->values[$key] = $setting ? $setting->value : ($this->categorySettings[$key]['default'] ?? null);
                $this->originalValues[$key] = $this->values[$key];
                
                $this->dispatch('setting-reset', settingKey: $key);
                $this->addFlash('success', 'è¨­å®šå·²é‡è¨­ç‚ºé è¨­å€¼');
            } else {
                $this->addFlash('error', 'è¨­å®šé‡è¨­å¤±æ•—');
            }
        } catch (\Exception $e) {
            $this->addFlash('error', "è¨­å®šé‡è¨­æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{$e->getMessage()}");
        }
    }

    /**
     * è‡ªå‹•å„²å­˜ç‰¹å®šè¨­å®š
     */
    public function autoSaveSetting(string $key): void
    {
        if (!$this->autoSave || !isset($this->values[$key])) {
            return;
        }

        // åªæœ‰åœ¨æœ‰è®Šæ›´æ™‚æ‰è‡ªå‹•å„²å­˜
        if (($this->originalValues[$key] ?? null) === $this->values[$key]) {
            return;
        }

        try {
            // é©—è­‰å–®å€‹è¨­å®š
            $fieldName = "values.{$key}";
            $rules = $this->validationRules();
            
            if (isset($rules[$fieldName])) {
                $validator = Validator::make(
                    [$fieldName => $this->values[$key]],
                    [$fieldName => $rules[$fieldName]]
                );

                if ($validator->fails()) {
                    return; // é©—è­‰å¤±æ•—æ™‚ä¸è‡ªå‹•å„²å­˜
                }
            }

            // æ›´æ–°è¨­å®š
            $result = $this->getSettingsRepository()->updateSetting($key, $this->values[$key]);

            if ($result) {
                $this->originalValues[$key] = $this->values[$key];
                $this->dispatch('setting-auto-saved', settingKey: $key);
            }

        } catch (\Exception $e) {
            // è‡ªå‹•å„²å­˜å¤±æ•—æ™‚ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œè®“ä½¿ç”¨è€…æ‰‹å‹•å„²å­˜
            logger()->warning("Auto-save failed for setting {$key}: " . $e->getMessage());
        }
    }

    /**
     * æ¸¬è©¦é€£ç·š
     */
    public function testConnection(string $type): void
    {
        try {
            // å»ºç«‹æ¸¬è©¦é…ç½®
            $testConfig = $this->buildConnectionTestConfig($type);
            
            // åŸ·è¡Œé€£ç·šæ¸¬è©¦
            $result = $this->getConfigService()->testConnection($type, $testConfig);
            
            if ($result) {
                $this->addFlash('success', 'é€£ç·šæ¸¬è©¦æˆåŠŸ');
            } else {
                $this->addFlash('error', 'é€£ç·šæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š');
            }

        } catch (\Exception $e) {
            $this->addFlash('error', "é€£ç·šæ¸¬è©¦éŒ¯èª¤ï¼š{$e->getMessage()}");
        }
    }

    /**
     * é©—è­‰æ‰€æœ‰è¨­å®š
     */
    protected function validateAllSettings(): bool
    {
        $this->resetValidationState();

        $rules = $this->validationRules();
        if (empty($rules)) {
            return true;
        }

        try {
            $validator = Validator::make($this->values, $rules);

            if ($validator->fails()) {
                $this->validationErrors = $validator->errors()->toArray();
                return false;
            }

            return true;
        } catch (\Exception $e) {
            $this->validationErrors = ['general' => [$e->getMessage()]];
            return false;
        }
    }

    /**
     * æª¢æŸ¥æ‰€æœ‰ä¾è³´é—œä¿‚
     */
    protected function checkAllDependencies(): void
    {
        $this->dependencyWarnings = [];

        foreach ($this->categorySettings as $key => $config) {
            if (!isset($config['depends_on'])) {
                continue;
            }

            $warnings = [];
            foreach ($config['depends_on'] as $dependentKey => $expectedValue) {
                $currentValue = $this->values[$dependentKey] ?? null;
                
                if ($currentValue !== $expectedValue) {
                    $dependentConfig = $this->categorySettings[$dependentKey] ?? [];
                    $warnings[] = [
                        'key' => $dependentKey,
                        'name' => $dependentConfig['description'] ?? $dependentKey,
                        'current_value' => $currentValue,
                        'expected_value' => $expectedValue,
                        'message' => "æ­¤è¨­å®šéœ€è¦ '{$dependentConfig['description']}' è¨­ç‚º '{$expectedValue}'"
                    ];
                }
            }

            if (!empty($warnings)) {
                $this->dependencyWarnings[$key] = $warnings;
            }
        }
    }

    /**
     * è™•ç†æª”æ¡ˆä¸Šå‚³
     */
    protected function handleFileUploads(): void
    {
        foreach ($this->uploadedFiles as $key => $file) {
            if (!$file) {
                continue;
            }

            $config = $this->categorySettings[$key] ?? [];
            
            // é©—è­‰æª”æ¡ˆ
            $rules = $this->getFileValidationRules($config);
            $validator = Validator::make(
                ['file' => $file],
                ['file' => $rules]
            );

            if ($validator->fails()) {
                throw new ValidationException($validator);
            }

            // å„²å­˜æª”æ¡ˆ
            $path = $file->store('settings', 'public');
            $this->values[$key] = asset("storage/{$path}");
        }

        $this->uploadedFiles = [];
    }

    /**
     * å–å¾—æª”æ¡ˆé©—è­‰è¦å‰‡
     */
    protected function getFileValidationRules(array $config): array
    {
        if (isset($config['validation'])) {
            if (is_string($config['validation'])) {
                return explode('|', $config['validation']);
            }
            return $config['validation'];
        }

        // é è¨­æª”æ¡ˆé©—è­‰è¦å‰‡
        $rules = ['file'];
        
        if (($config['type'] ?? '') === 'image') {
            $rules[] = 'image';
            $rules[] = 'mimes:jpeg,png,jpg,gif,svg';
            $rules[] = 'max:2048'; // 2MB
        } else {
            $rules[] = 'max:5120'; // 5MB
        }

        return $rules;
    }

    /**
     * å»ºç«‹é€£ç·šæ¸¬è©¦é…ç½®
     */
    protected function buildConnectionTestConfig(string $type): array
    {
        $testableSettings = config('system-settings.testable_settings', []);
        
        if (!isset($testableSettings[$type])) {
            return [];
        }

        $config = [];
        $settingKeys = $testableSettings[$type]['settings'];
        
        foreach ($settingKeys as $key) {
            if (isset($this->values[$key])) {
                $config[str_replace($type . '.', '', $key)] = $this->values[$key];
            }
        }

        return $config;
    }

    /**
     * é‡è¨­é©—è­‰ç‹€æ…‹
     */
    protected function resetValidationState(): void
    {
        $this->validationErrors = [];
    }

    /**
     * æ›´æ–°å€¼æ™‚çš„è™•ç†
     */
    public function updatedValues($value, $key): void
    {
        // æª¢æŸ¥ä¾è³´é—œä¿‚
        $this->checkAllDependencies();
        
        // å¦‚æœå•Ÿç”¨è‡ªå‹•å„²å­˜ï¼Œå»¶é²å„²å­˜
        if ($this->autoSave) {
            $this->dispatch('auto-save-scheduled', settingKey: $key);
        }
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.settings.category-settings-form');
    }
}