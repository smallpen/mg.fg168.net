<?php

namespace App\Livewire\Admin\Activities;

use App\Models\NotificationRule;
use App\Models\User;
use App\Models\Role;
use Livewire\Component;
use Livewire\WithPagination;
use Livewire\Attributes\On;

/**
 * é€šçŸ¥è¦å‰‡ç®¡ç†å…ƒä»¶
 * 
 * ç®¡ç†æ´»å‹•è¨˜éŒ„çš„é€šçŸ¥è¦å‰‡ï¼ŒåŒ…å«å»ºç«‹ã€ç·¨è¼¯ã€åˆªé™¤å’Œæ¸¬è©¦åŠŸèƒ½
 */
class NotificationRules extends Component
{
    use WithPagination;

    // ç¯©é¸æ¢ä»¶
    public string $search = '';
    public string $statusFilter = 'all'; // all, active, inactive
    public string $priorityFilter = 'all';
    public string $creatorFilter = 'all';

    // é¡¯ç¤ºè¨­å®š
    public int $perPage = 20;
    public string $sortField = 'created_at';
    public string $sortDirection = 'desc';

    // è¡¨å–®è³‡æ–™
    public bool $showForm = false;
    public bool $editMode = false;
    public ?NotificationRule $editingRule = null;

    public string $name = '';
    public string $description = '';
    public array $conditions = [];
    public array $actions = [];
    public bool $isActive = true;
    public int $priority = 2;

    // æ¢ä»¶è¡¨å–®
    public array $activityTypes = [];
    public int $minRiskLevel = 0;
    public array $userIds = [];
    public array $ipPatterns = [];
    public array $timeRange = [];
    public array $frequencyLimit = [];

    // å‹•ä½œè¡¨å–®
    public array $recipients = [];
    public string $titleTemplate = '';
    public string $messageTemplate = '';
    public bool $mergeSimilar = false;
    public int $mergeWindow = 300;
    public bool $emailNotification = false;
    public bool $browserNotification = false;
    public bool $webhookNotification = false;
    public string $webhookUrl = '';
    public bool $securityAlert = false;

    // æ‰¹é‡æ“ä½œ
    public array $selectedRules = [];
    public string $bulkAction = '';

    protected array $rules = [
        'name' => 'required|string|max:255',
        'description' => 'nullable|string|max:1000',
        'priority' => 'required|integer|between:1,4',
        'activityTypes' => 'array',
        'minRiskLevel' => 'integer|between:0,10',
        'userIds' => 'array',
        'ipPatterns' => 'array',
        'recipients' => 'required|array|min:1',
        'titleTemplate' => 'required|string|max:255',
        'messageTemplate' => 'required|string|max:1000',
        'mergeWindow' => 'integer|min:60|max:3600',
        'webhookUrl' => 'nullable|url',
    ];

    protected array $messages = [
        'name.required' => 'è¦å‰‡åç¨±ç‚ºå¿…å¡«é …ç›®',
        'recipients.required' => 'å¿…é ˆé¸æ“‡è‡³å°‘ä¸€å€‹é€šçŸ¥æ¥æ”¶è€…',
        'recipients.min' => 'å¿…é ˆé¸æ“‡è‡³å°‘ä¸€å€‹é€šçŸ¥æ¥æ”¶è€…',
        'titleTemplate.required' => 'é€šçŸ¥æ¨™é¡Œç¯„æœ¬ç‚ºå¿…å¡«é …ç›®',
        'messageTemplate.required' => 'é€šçŸ¥è¨Šæ¯ç¯„æœ¬ç‚ºå¿…å¡«é …ç›®',
        'webhookUrl.url' => 'Webhook URL æ ¼å¼ä¸æ­£ç¢º',
    ];

    public function mount(): void
    {
        $this->authorize('activity_logs.view');
        $this->resetForm();
    }

    public function render()
    {
        $rules = $this->getRulesQuery()->paginate($this->perPage);
        
        return view('livewire.admin.activities.notification-rules', [
            'rules' => $rules,
            'users' => $this->getUsers(),
            'roles' => $this->getRoles(),
            'activityTypeOptions' => $this->getActivityTypeOptions(),
            'statistics' => $this->getStatistics(),
        ]);
    }

    /**
     * å–å¾—è¦å‰‡æŸ¥è©¢
     */
    protected function getRulesQuery()
    {
        $query = NotificationRule::with(['creator']);

        // æœå°‹
        if ($this->search) {
            $query->where(function ($q) {
                $q->where('name', 'like', "%{$this->search}%")
                  ->orWhere('description', 'like', "%{$this->search}%");
            });
        }

        // ç‹€æ…‹ç¯©é¸
        if ($this->statusFilter === 'active') {
            $query->active();
        } elseif ($this->statusFilter === 'inactive') {
            $query->inactive();
        }

        // å„ªå…ˆç´šç¯©é¸
        if ($this->priorityFilter !== 'all') {
            $query->where('priority', $this->priorityFilter);
        }

        // å»ºç«‹è€…ç¯©é¸
        if ($this->creatorFilter !== 'all') {
            $query->where('created_by', $this->creatorFilter);
        }

        // æ’åº
        $query->orderBy($this->sortField, $this->sortDirection);

        return $query;
    }

    /**
     * é¡¯ç¤ºå»ºç«‹è¡¨å–®
     */
    public function create(): void
    {
        $this->authorize('activity_logs.create');
        $this->resetForm();
        $this->showForm = true;
        $this->editMode = false;
    }

    /**
     * é¡¯ç¤ºç·¨è¼¯è¡¨å–®
     */
    public function edit(NotificationRule $rule): void
    {
        $this->authorize('activity_logs.edit');
        $this->editingRule = $rule;
        $this->loadRuleData($rule);
        $this->showForm = true;
        $this->editMode = true;
    }

    /**
     * å„²å­˜è¦å‰‡
     */
    public function save(): void
    {
        $this->authorize($this->editMode ? 'activity_logs.edit' : 'activity_logs.create');
        
        $this->validate();

        try {
            $data = $this->prepareRuleData();

            if ($this->editMode) {
                $this->editingRule->update($data);
                $message = 'é€šçŸ¥è¦å‰‡æ›´æ–°æˆåŠŸ';
            } else {
                NotificationRule::create($data);
                $message = 'é€šçŸ¥è¦å‰‡å»ºç«‹æˆåŠŸ';
            }

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => $message
            ]);

            $this->resetForm();
            $this->showForm = false;

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'å„²å­˜å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * åˆªé™¤è¦å‰‡
     */
    public function delete(NotificationRule $rule): void
    {
        $this->authorize('activity_logs.delete');

        try {
            $rule->delete();

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'é€šçŸ¥è¦å‰‡åˆªé™¤æˆåŠŸ'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'åˆªé™¤å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * åˆ‡æ›è¦å‰‡ç‹€æ…‹
     */
    public function toggleStatus(NotificationRule $rule): void
    {
        $this->authorize('activity_logs.edit');

        try {
            $rule->update(['is_active' => !$rule->is_active]);

            $status = $rule->is_active ? 'å•Ÿç”¨' : 'åœç”¨';
            $this->dispatch('notification', [
                'type' => 'success',
                'message' => "è¦å‰‡å·²{$status}"
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'ç‹€æ…‹åˆ‡æ›å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * è¤‡è£½è¦å‰‡
     */
    public function duplicate(NotificationRule $rule): void
    {
        $this->authorize('activity_logs.create');

        try {
            $newRule = $rule->duplicate();

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'è¦å‰‡è¤‡è£½æˆåŠŸ'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'è¤‡è£½å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * æ¸¬è©¦è¦å‰‡
     */
    public function testRule(NotificationRule $rule): void
    {
        $this->authorize('activity_logs.view');

        try {
            // é€™è£¡å¯ä»¥å¯¦ä½œè¦å‰‡æ¸¬è©¦é‚è¼¯
            // ä¾‹å¦‚ç™¼é€æ¸¬è©¦é€šçŸ¥æˆ–æ¨¡æ“¬è¦å‰‡è§¸ç™¼

            $this->dispatch('notification', [
                'type' => 'info',
                'message' => 'æ¸¬è©¦é€šçŸ¥å·²ç™¼é€'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ¸¬è©¦å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * åŸ·è¡Œæ‰¹é‡æ“ä½œ
     */
    public function executeBulkAction(): void
    {
        if (empty($this->selectedRules) || empty($this->bulkAction)) {
            return;
        }

        $this->authorize('activity_logs.edit');

        try {
            $rules = NotificationRule::whereIn('id', $this->selectedRules);

            switch ($this->bulkAction) {
                case 'activate':
                    $rules->update(['is_active' => true]);
                    $message = 'å·²å•Ÿç”¨é¸ä¸­çš„è¦å‰‡';
                    break;

                case 'deactivate':
                    $rules->update(['is_active' => false]);
                    $message = 'å·²åœç”¨é¸ä¸­çš„è¦å‰‡';
                    break;

                case 'delete':
                    $this->authorize('activity_logs.delete');
                    $rules->delete();
                    $message = 'å·²åˆªé™¤é¸ä¸­çš„è¦å‰‡';
                    break;

                default:
                    throw new \InvalidArgumentException('ç„¡æ•ˆçš„æ‰¹é‡æ“ä½œ');
            }

            $this->selectedRules = [];
            $this->bulkAction = '';

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => $message
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ‰¹é‡æ“ä½œå¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * æ¸…é™¤ç¯©é¸
     */
    public function clearFilters(): void
    {
        try {
        // è¨˜éŒ„é‡ç½®æ“ä½œ
        \Log::info('ğŸ”„ clearFilters - æ–¹æ³•è¢«å‘¼å«', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
        ]);
        
        // é‡ç½®å±¬æ€§
        $this->search = '';
        $this->statusFilter = '';
        $this->priorityFilter = '';
        $this->creatorFilter = '';
        $this->showForm = false;
        $this->editMode = '';
        $this->name = '';
        $this->description = '';
        $this->conditions = '';
        $this->actions = '';
        $this->isActive = false;
        $this->priority = '';
        $this->activityTypes = '';
        $this->minRiskLevel = false;
        $this->userIds = '';
        $this->ipPatterns = '';
        $this->timeRange = '';
        $this->frequencyLimit = '';
        $this->recipients = '';
        $this->titleTemplate = '';
        $this->messageTemplate = '';
        $this->mergeSimilar = '';
        $this->mergeWindow = '';
        $this->emailNotification = '';
        $this->browserNotification = '';
        $this->webhookNotification = '';
        $this->webhookUrl = '';
        $this->securityAlert = '';
        $this->selectedRules = [];
        $this->bulkAction = '';
        $this->resetPage();
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('clearFilters-completed');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… clearFilters - é‡ç½®å®Œæˆ');

        
        $this->resetValidation();
    } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'clearFilters',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * å–æ¶ˆè¡¨å–®
     */
    public function cancel(): void
    {
        $this->resetForm();
        $this->showForm = false;
    }

    /**
     * é‡è¨­è¡¨å–®
     */
    protected function resetForm(): void
    {
        $this->editingRule = null;
        $this->name = '';
        $this->description = '';
        $this->conditions = [];
        $this->actions = [];
        $this->isActive = true;
        $this->priority = 2;

        // é‡è¨­æ¢ä»¶è¡¨å–®
        $this->activityTypes = [];
        $this->minRiskLevel = 0;
        $this->userIds = [];
        $this->ipPatterns = [];
        $this->timeRange = [];
        $this->frequencyLimit = [];

        // é‡è¨­å‹•ä½œè¡¨å–®
        $this->recipients = [];
        $this->titleTemplate = 'æ´»å‹•è¨˜éŒ„è­¦å ±ï¼š{activity_type}';
        $this->messageTemplate = 'ä½¿ç”¨è€… {user_name} åœ¨ {time} åŸ·è¡Œäº† {activity_type} æ“ä½œï¼š{description}';
        $this->mergeSimilar = false;
        $this->mergeWindow = 300;
        $this->emailNotification = false;
        $this->browserNotification = false;
        $this->webhookNotification = false;
        $this->webhookUrl = '';
        $this->securityAlert = false;
    }

    /**
     * è¼‰å…¥è¦å‰‡è³‡æ–™
     */
    protected function loadRuleData(NotificationRule $rule): void
    {
        $this->name = $rule->name;
        $this->description = $rule->description ?? '';
        $this->isActive = $rule->is_active;
        $this->priority = $rule->priority;

        // è¼‰å…¥æ¢ä»¶
        $conditions = $rule->conditions ?? [];
        $this->activityTypes = $conditions['activity_types'] ?? [];
        $this->minRiskLevel = $conditions['min_risk_level'] ?? 0;
        $this->userIds = $conditions['user_ids'] ?? [];
        $this->ipPatterns = $conditions['ip_patterns'] ?? [];
        $this->timeRange = $conditions['time_range'] ?? [];
        $this->frequencyLimit = $conditions['frequency_limit'] ?? [];

        // è¼‰å…¥å‹•ä½œ
        $actions = $rule->actions ?? [];
        $this->recipients = $actions['recipients'] ?? [];
        $this->titleTemplate = $actions['title_template'] ?? '';
        $this->messageTemplate = $actions['message_template'] ?? '';
        $this->mergeSimilar = $actions['merge_similar'] ?? false;
        $this->mergeWindow = $actions['merge_window'] ?? 300;

        // æª¢æŸ¥å‹•ä½œé¡å‹
        foreach ($actions as $action) {
            switch ($action['type']) {
                case 'email':
                    $this->emailNotification = true;
                    break;
                case 'browser':
                    $this->browserNotification = true;
                    break;
                case 'webhook':
                    $this->webhookNotification = true;
                    $this->webhookUrl = $action['url'] ?? '';
                    break;
                case 'security_alert':
                    $this->securityAlert = true;
                    break;
            }
        }
    }

    /**
     * æº–å‚™è¦å‰‡è³‡æ–™
     */
    protected function prepareRuleData(): array
    {
        // æº–å‚™æ¢ä»¶
        $conditions = [];
        if (!empty($this->activityTypes)) {
            $conditions['activity_types'] = $this->activityTypes;
        }
        if ($this->minRiskLevel > 0) {
            $conditions['min_risk_level'] = $this->minRiskLevel;
        }
        if (!empty($this->userIds)) {
            $conditions['user_ids'] = $this->userIds;
        }
        if (!empty($this->ipPatterns)) {
            $conditions['ip_patterns'] = array_filter($this->ipPatterns);
        }
        if (!empty($this->timeRange)) {
            $conditions['time_range'] = $this->timeRange;
        }
        if (!empty($this->frequencyLimit)) {
            $conditions['frequency_limit'] = $this->frequencyLimit;
        }

        // æº–å‚™å‹•ä½œ
        $actions = [
            'recipients' => $this->recipients,
            'title_template' => $this->titleTemplate,
            'message_template' => $this->messageTemplate,
            'merge_similar' => $this->mergeSimilar,
            'merge_window' => $this->mergeWindow,
        ];

        $actionList = [];
        if ($this->emailNotification) {
            $actionList[] = ['type' => 'email', 'template' => 'activity_notification'];
        }
        if ($this->browserNotification) {
            $actionList[] = ['type' => 'browser'];
        }
        if ($this->webhookNotification && $this->webhookUrl) {
            $actionList[] = ['type' => 'webhook', 'url' => $this->webhookUrl];
        }
        if ($this->securityAlert) {
            $actionList[] = ['type' => 'security_alert'];
        }

        $actions['actions'] = $actionList;

        return [
            'name' => $this->name,
            'description' => $this->description,
            'conditions' => $conditions,
            'actions' => $actions,
            'is_active' => $this->isActive,
            'priority' => $this->priority,
            'created_by' => auth()->id(),
        ];
    }

    /**
     * å–å¾—ä½¿ç”¨è€…åˆ—è¡¨
     */
    protected function getUsers()
    {
        return User::select('id', 'name', 'username')
            ->where('is_active', true)
            ->orderBy('name')
            ->get();
    }

    /**
     * å–å¾—è§’è‰²åˆ—è¡¨
     */
    protected function getRoles()
    {
        return Role::select('id', 'name', 'display_name')
            ->orderBy('display_name')
            ->get();
    }

    /**
     * å–å¾—æ´»å‹•é¡å‹é¸é …
     */
    protected function getActivityTypeOptions(): array
    {
        return [
            'login' => 'ç™»å…¥',
            'logout' => 'ç™»å‡º',
            'create' => 'å»ºç«‹',
            'update' => 'æ›´æ–°',
            'delete' => 'åˆªé™¤',
            'security' => 'å®‰å…¨äº‹ä»¶',
            'system' => 'ç³»çµ±äº‹ä»¶',
        ];
    }

    /**
     * å–å¾—çµ±è¨ˆè³‡è¨Š
     */
    protected function getStatistics(): array
    {
        return NotificationRule::getStatistics();
    }

    /**
     * æ›´æ–°æ’åº
     */
    public function updateSort(string $field): void
    {
        if ($this->sortField === $field) {
            $this->sortDirection = $this->sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            $this->sortField = $field;
            $this->sortDirection = 'asc';
        }
    }

    /**
     * æ›´æ–°æ¯é é¡¯ç¤ºæ•¸é‡
     */
    public function updatedPerPage(): void
    {
        $this->resetPage();
    }

    /**
     * æ›´æ–°æœå°‹æ¢ä»¶
     */
    public function updatedSearch(): void
    {
        $this->resetPage();
    }

    /**
     * æ›´æ–°ç¯©é¸æ¢ä»¶
     */
    public function updatedStatusFilter(): void
    {
        $this->resetPage();
    }

    public function updatedPriorityFilter(): void
    {
        $this->resetPage();
    }

    public function updatedCreatorFilter(): void
    {
        $this->resetPage();
    }
}
