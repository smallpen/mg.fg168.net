<?php

namespace App\Livewire\Admin\Activities;

use App\Models\Notification;
use App\Models\User;
use Livewire\Component;
use Livewire\WithPagination;
use Livewire\Attributes\On;
use Carbon\Carbon;

/**
 * é€šçŸ¥åˆ—è¡¨å…ƒä»¶
 * 
 * é¡¯ç¤ºå’Œç®¡ç†æ´»å‹•è¨˜éŒ„ç›¸é—œçš„é€šçŸ¥
 */
class NotificationList extends Component
{
    use WithPagination;

    // ç¯©é¸æ¢ä»¶
    public string $search = '';
    public string $typeFilter = 'all';
    public string $priorityFilter = 'all';
    public string $statusFilter = 'all'; // all, read, unread
    public string $userFilter = 'all';
    public string $dateFrom = '';
    public string $dateTo = '';

    // é¡¯ç¤ºè¨­å®š
    public int $perPage = 20;
    public string $sortField = 'created_at';
    public string $sortDirection = 'desc';

    // æ‰¹é‡æ“ä½œ
    public array $selectedNotifications = [];
    public string $bulkAction = '';

    // è©³æƒ…é¡¯ç¤º
    public ?Notification $selectedNotification = null;
    public bool $showDetail = false;

    protected array $queryString = [
        'search' => ['except' => ''],
        'typeFilter' => ['except' => 'all'],
        'priorityFilter' => ['except' => 'all'],
        'statusFilter' => ['except' => 'all'],
        'page' => ['except' => 1],
    ];

    public function mount(): void
    {
        $this->authorize('activity_logs.view');
        
        // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆæœ€è¿‘ 7 å¤©ï¼‰
        $this->dateTo = Carbon::now()->format('Y-m-d');
        $this->dateFrom = Carbon::now()->subDays(7)->format('Y-m-d');
    }

    public function render()
    {
        $notifications = $this->getNotificationsQuery()->paginate($this->perPage);
        
        return view('livewire.admin.activities.notification-list', [
            'notifications' => $notifications,
            'users' => $this->getUsers(),
            'statistics' => $this->getStatistics(),
            'typeOptions' => $this->getTypeOptions(),
        ]);
    }

    /**
     * å–å¾—é€šçŸ¥æŸ¥è©¢
     */
    protected function getNotificationsQuery()
    {
        $query = Notification::with(['user'])
            ->where('type', 'activity_log');

        // æœå°‹
        if ($this->search) {
            $query->where(function ($q) {
                $q->where('title', 'like', "%{$this->search}%")
                  ->orWhere('message', 'like', "%{$this->search}%")
                  ->orWhereHas('user', function ($userQuery) {
                      $userQuery->where('name', 'like', "%{$this->search}%")
                               ->orWhere('username', 'like', "%{$this->search}%");
                  });
            });
        }

        // é¡å‹ç¯©é¸
        if ($this->typeFilter !== 'all') {
            $query->where('data->activity_type', $this->typeFilter);
        }

        // å„ªå…ˆç´šç¯©é¸
        if ($this->priorityFilter !== 'all') {
            $query->where('priority', $this->priorityFilter);
        }

        // ç‹€æ…‹ç¯©é¸
        if ($this->statusFilter === 'read') {
            $query->whereNotNull('read_at');
        } elseif ($this->statusFilter === 'unread') {
            $query->whereNull('read_at');
        }

        // ä½¿ç”¨è€…ç¯©é¸
        if ($this->userFilter !== 'all') {
            $query->where('user_id', $this->userFilter);
        }

        // æ—¥æœŸç¯„åœç¯©é¸
        if ($this->dateFrom) {
            $query->whereDate('created_at', '>=', $this->dateFrom);
        }
        if ($this->dateTo) {
            $query->whereDate('created_at', '<=', $this->dateTo);
        }

        // æ’åº
        $query->orderBy($this->sortField, $this->sortDirection);

        return $query;
    }

    /**
     * é¡¯ç¤ºé€šçŸ¥è©³æƒ…
     */
    public function showDetail(Notification $notification): void
    {
        $this->selectedNotification = $notification;
        $this->showDetail = true;

        // å¦‚æœæ˜¯æœªè®€é€šçŸ¥ï¼Œæ¨™è¨˜ç‚ºå·²è®€
        if ($notification->isUnread()) {
            $notification->markAsRead();
        }
    }

    /**
     * é—œé–‰è©³æƒ…
     */
    public function closeDetail(): void
    {
        $this->selectedNotification = null;
        $this->showDetail = false;
    }

    /**
     * æ¨™è¨˜ç‚ºå·²è®€
     */
    public function markAsRead(Notification $notification): void
    {
        try {
            $notification->markAsRead();

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'é€šçŸ¥å·²æ¨™è¨˜ç‚ºå·²è®€'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ“ä½œå¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * æ¨™è¨˜ç‚ºæœªè®€
     */
    public function markAsUnread(Notification $notification): void
    {
        try {
            $notification->markAsUnread();

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'é€šçŸ¥å·²æ¨™è¨˜ç‚ºæœªè®€'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ“ä½œå¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * åˆªé™¤é€šçŸ¥
     */
    public function deleteNotification(Notification $notification): void
    {
        $this->authorize('activity_logs.delete');

        try {
            $notification->delete();

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'é€šçŸ¥å·²åˆªé™¤'
            ]);

            // å¦‚æœæ­£åœ¨é¡¯ç¤ºè©³æƒ…ï¼Œé—œé–‰è©³æƒ…è¦–çª—
            if ($this->selectedNotification && $this->selectedNotification->id === $notification->id) {
                $this->closeDetail();
            }

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'åˆªé™¤å¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * åŸ·è¡Œæ‰¹é‡æ“ä½œ
     */
    public function executeBulkAction(): void
    {
        if (empty($this->selectedNotifications) || empty($this->bulkAction)) {
            return;
        }

        try {
            $notifications = Notification::whereIn('id', $this->selectedNotifications);

            switch ($this->bulkAction) {
                case 'mark_read':
                    $notifications->update(['read_at' => Carbon::now()]);
                    $message = 'å·²æ¨™è¨˜é¸ä¸­çš„é€šçŸ¥ç‚ºå·²è®€';
                    break;

                case 'mark_unread':
                    $notifications->update(['read_at' => null]);
                    $message = 'å·²æ¨™è¨˜é¸ä¸­çš„é€šçŸ¥ç‚ºæœªè®€';
                    break;

                case 'delete':
                    $this->authorize('activity_logs.delete');
                    $notifications->delete();
                    $message = 'å·²åˆªé™¤é¸ä¸­çš„é€šçŸ¥';
                    break;

                default:
                    throw new \InvalidArgumentException('ç„¡æ•ˆçš„æ‰¹é‡æ“ä½œ');
            }

            $this->selectedNotifications = [];
            $this->bulkAction = '';

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => $message
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ‰¹é‡æ“ä½œå¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * æ¨™è¨˜æ‰€æœ‰ç‚ºå·²è®€
     */
    public function markAllAsRead(): void
    {
        try {
            $this->getNotificationsQuery()
                ->whereNull('read_at')
                ->update(['read_at' => Carbon::now()]);

            $this->dispatch('notification', [
                'type' => 'success',
                'message' => 'æ‰€æœ‰é€šçŸ¥å·²æ¨™è¨˜ç‚ºå·²è®€'
            ]);

        } catch (\Exception $e) {
            $this->dispatch('notification', [
                'type' => 'error',
                'message' => 'æ“ä½œå¤±æ•—ï¼š' . $e->getMessage()
            ]);
        }
    }

    /**
     * æ¸…é™¤ç¯©é¸ - ä¿®å¾©ç‰ˆæœ¬
     */
    public function clearFilters(): void
    {
        \Log::info('ğŸ”¥ NotificationList clearFilters - æ–¹æ³•è¢«å‘¼å«äº†ï¼', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
            'before_reset' => [
                'search' => $this->search,
                'typeFilter' => $this->typeFilter,
                'priorityFilter' => $this->priorityFilter,
                'statusFilter' => $this->statusFilter,
                'userFilter' => $this->userFilter,
                'dateFrom' => $this->dateFrom,
                'dateTo' => $this->dateTo,
            ]
        ]);
        
        // é‡ç½®æ‰€æœ‰ç¯©é¸æ¢ä»¶
        $this->search = '';
        $this->typeFilter = 'all';
        $this->priorityFilter = 'all';
        $this->statusFilter = 'all';
        $this->userFilter = 'all';
        $this->dateTo = Carbon::now()->format('Y-m-d');
        $this->dateFrom = Carbon::now()->subDays(7)->format('Y-m-d');
        
        // æ¸…é™¤é¸ä¸­çš„é€šçŸ¥
        $this->selectedNotifications = [];
        $this->bulkAction = '';
        
        // é‡ç½®åˆ†é 
        $this->resetPage();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('notification-list-reset');
        
        \Log::info('ğŸ”¥ NotificationList clearFilters - å±¬æ€§å·²é‡ç½®', [
            'after_reset' => [
                'search' => $this->search,
                'typeFilter' => $this->typeFilter,
                'priorityFilter' => $this->priorityFilter,
                'statusFilter' => $this->statusFilter,
                'userFilter' => $this->userFilter,
                'dateFrom' => $this->dateFrom,
                'dateTo' => $this->dateTo,
            ]
        ]);
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        $this->dispatch('notification', [
            'type' => 'success',
            'message' => 'ç¯©é¸æ¢ä»¶å·²æ¸…é™¤'
        ]);
        
        \Log::info('ğŸ”¥ NotificationList clearFilters - ä¿®å¾©ç‰ˆæœ¬åŸ·è¡Œå®Œæˆ');
    }

    /**
     * å–å¾—ä½¿ç”¨è€…åˆ—è¡¨
     */
    protected function getUsers()
    {
        return User::select('id', 'name', 'username')
            ->whereHas('notifications', function ($query) {
                $query->where('type', 'activity_log');
            })
            ->orderBy('name')
            ->get();
    }

    /**
     * å–å¾—çµ±è¨ˆè³‡è¨Š
     */
    protected function getStatistics(): array
    {
        $baseQuery = Notification::where('type', 'activity_log');

        return [
            'total' => $baseQuery->count(),
            'unread' => $baseQuery->whereNull('read_at')->count(),
            'today' => $baseQuery->whereDate('created_at', Carbon::today())->count(),
            'this_week' => $baseQuery->whereBetween('created_at', [
                Carbon::now()->startOfWeek(),
                Carbon::now()->endOfWeek()
            ])->count(),
        ];
    }

    /**
     * å–å¾—é¡å‹é¸é …
     */
    protected function getTypeOptions(): array
    {
        return [
            'login' => 'ç™»å…¥',
            'logout' => 'ç™»å‡º',
            'create' => 'å»ºç«‹',
            'update' => 'æ›´æ–°',
            'delete' => 'åˆªé™¤',
            'security' => 'å®‰å…¨äº‹ä»¶',
            'system' => 'ç³»çµ±äº‹ä»¶',
        ];
    }

    /**
     * æ›´æ–°æ’åº
     */
    public function updateSort(string $field): void
    {
        if ($this->sortField === $field) {
            $this->sortDirection = $this->sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            $this->sortField = $field;
            $this->sortDirection = 'asc';
        }
    }

    /**
     * ç›£è½æ–°é€šçŸ¥äº‹ä»¶
     */
    #[On('notification-received')]
    public function refreshNotifications(): void
    {
        // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
        $this->resetPage();
    }

    /**
     * æ›´æ–°æ¯é é¡¯ç¤ºæ•¸é‡
     */
    public function updatedPerPage(): void
    {
        $this->resetPage();
    }

    /**
     * æ›´æ–°æœå°‹æ¢ä»¶
     */
    public function updatedSearch(): void
    {
        $this->resetPage();
    }

    /**
     * æ›´æ–°ç¯©é¸æ¢ä»¶
     */
    public function updatedTypeFilter(): void
    {
        $this->resetPage();
    }

    public function updatedPriorityFilter(): void
    {
        $this->resetPage();
    }

    public function updatedStatusFilter(): void
    {
        $this->resetPage();
    }

    public function updatedUserFilter(): void
    {
        $this->resetPage();
    }

    public function updatedDateFrom(): void
    {
        $this->resetPage();
    }

    public function updatedDateTo(): void
    {
        $this->resetPage();
    }
}
