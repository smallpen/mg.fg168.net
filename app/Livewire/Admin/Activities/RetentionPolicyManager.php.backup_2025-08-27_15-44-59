<?php

namespace App\Livewire\Admin\Activities;

use App\Models\ActivityRetentionPolicy;
use App\Models\ActivityCleanupLog;
use App\Services\ActivityRetentionService;
use Livewire\Component;
use Livewire\WithPagination;
use Livewire\Attributes\On;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;

/**
 * æ´»å‹•è¨˜éŒ„ä¿ç•™æ”¿ç­–ç®¡ç†å…ƒä»¶
 * 
 * æä¾›ä¿ç•™æ”¿ç­–çš„å»ºç«‹ã€ç·¨è¼¯ã€åˆªé™¤å’ŒåŸ·è¡ŒåŠŸèƒ½
 */
class RetentionPolicyManager extends Component
{
    use WithPagination, AuthorizesRequests;

    /**
     * æœå°‹é—œéµå­—
     */
    public string $search = '';

    /**
     * ç¯©é¸æ¢ä»¶
     */
    public string $statusFilter = '';
    public string $actionFilter = '';

    /**
     * æŽ’åºè¨­å®š
     */
    public string $sortField = 'priority';
    public string $sortDirection = 'desc';

    /**
     * é¡¯ç¤ºæ¨¡å¼
     */
    public string $viewMode = 'list'; // list, stats, logs

    /**
     * æ”¿ç­–è¡¨å–®è³‡æ–™
     */
    public array $policyForm = [
        'name' => '',
        'activity_type' => '',
        'module' => '',
        'retention_days' => 90,
        'action' => 'archive',
        'is_active' => true,
        'priority' => 1,
        'conditions' => [],
        'description' => '',
    ];

    /**
     * æ‰‹å‹•æ¸…ç†è¡¨å–®è³‡æ–™
     */
    public array $cleanupForm = [
        'date_from' => '',
        'date_to' => '',
        'activity_type' => '',
        'module' => '',
        'action' => 'archive',
        'risk_level_min' => '',
        'risk_level_max' => '',
    ];

    /**
     * é¡¯ç¤ºç‹€æ…‹
     */
    public bool $showPolicyModal = false;
    public bool $showCleanupModal = false;
    public bool $showPreviewModal = false;
    public bool $editMode = false;
    public ?int $editingPolicyId = null;

    /**
     * é è¦½è³‡æ–™
     */
    public array $previewData = [];

    /**
     * çµ±è¨ˆè³‡æ–™
     */
    public array $stats = [];

    /**
     * æ´»å‹•ä¿ç•™æœå‹™
     */
    protected ActivityRetentionService $retentionService;

    /**
     * åˆå§‹åŒ–å…ƒä»¶
     */
    public function mount()
    {
        $this->authorize('system.logs');
        $this->retentionService = app(ActivityRetentionService::class);
        $this->loadStats();
        
        // è¨­å®šé è¨­æ—¥æœŸç¯„åœ
        $this->cleanupForm['date_to'] = now()->format('Y-m-d');
        $this->cleanupForm['date_from'] = now()->subDays(90)->format('Y-m-d');
    }

    /**
     * è¼‰å…¥çµ±è¨ˆè³‡æ–™
     */
    public function loadStats(): void
    {
        $this->stats = [
            'policy_stats' => $this->retentionService->getPolicyStats(),
            'cleanup_history' => $this->retentionService->getCleanupHistory('30d'),
            'archive_stats' => $this->retentionService->getArchiveStats('30d'),
        ];
    }

    /**
     * å–å¾—ä¿ç•™æ”¿ç­–åˆ—è¡¨
     */
    public function getPoliciesProperty()
    {
        $query = ActivityRetentionPolicy::with(['creator', 'cleanupLogs' => function ($q) {
            $q->recent(7)->completed();
        }]);

        // æ‡‰ç”¨æœå°‹
        if ($this->search) {
            $query->where(function ($q) {
                $q->where('name', 'like', "%{$this->search}%")
                  ->orWhere('description', 'like', "%{$this->search}%")
                  ->orWhere('activity_type', 'like', "%{$this->search}%")
                  ->orWhere('module', 'like', "%{$this->search}%");
            });
        }

        // æ‡‰ç”¨ç¯©é¸
        if ($this->statusFilter) {
            $isActive = $this->statusFilter === 'active';
            $query->where('is_active', $isActive);
        }

        if ($this->actionFilter) {
            $query->where('action', $this->actionFilter);
        }

        // æ‡‰ç”¨æŽ’åº
        $query->orderBy($this->sortField, $this->sortDirection);

        return $query->paginate(10);
    }

    /**
     * å–å¾—æ¸…ç†æ—¥èªŒåˆ—è¡¨
     */
    public function getCleanupLogsProperty()
    {
        return ActivityCleanupLog::with(['policy', 'executor'])
            ->recent(30)
            ->orderBy('started_at', 'desc')
            ->paginate(10);
    }

    /**
     * åˆ‡æ›æª¢è¦–æ¨¡å¼
     */
    public function setViewMode(string $mode): void
    {
        $this->viewMode = $mode;
        
        if ($mode === 'stats') {
            $this->loadStats();
        }
    }

    /**
     * æŽ’åº
     */
    public function sortBy(string $field): void
    {
        if ($this->sortField === $field) {
            $this->sortDirection = $this->sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            $this->sortField = $field;
            $this->sortDirection = 'asc';
        }

        $this->resetPage();
    }

    /**
     * æ¸…é™¤ç¯©é¸
     */
    public function clearFilters(): void
    {
        try {
        // è¨˜éŒ„é‡ç½®æ“ä½œ
        \Log::info('ðŸ”„ clearFilters - æ–¹æ³•è¢«å‘¼å«', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
        ]);
        
        // é‡ç½®å±¬æ€§
        $this->search = '';
        $this->statusFilter = '';
        $this->actionFilter = '';
        $this->viewMode = '';
        $this->policyForm = '';
        $this->cleanupForm = '';
        $this->showPolicyModal = false;
        $this->showCleanupModal = false;
        $this->showPreviewModal = false;
        $this->editMode = '';
        $this->editingPolicyId = '';
        $this->previewData = '';
        $this->stats = '';
        $this->resetPage();
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('clearFilters-completed');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… clearFilters - é‡ç½®å®Œæˆ');

        
        $this->resetValidation();
    } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'clearFilters',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * é–‹å•Ÿæ–°å¢žæ”¿ç­–æ¨¡æ…‹æ¡†
     */
    public function openCreateModal(): void
    {
        $this->resetPolicyForm();
        $this->editMode = false;
        $this->showPolicyModal = true;
    }

    /**
     * é–‹å•Ÿç·¨è¼¯æ”¿ç­–æ¨¡æ…‹æ¡†
     */
    public function openEditModal(int $policyId): void
    {
        $policy = ActivityRetentionPolicy::findOrFail($policyId);
        
        $this->policyForm = [
            'name' => $policy->name,
            'activity_type' => $policy->activity_type ?? '',
            'module' => $policy->module ?? '',
            'retention_days' => $policy->retention_days,
            'action' => $policy->action,
            'is_active' => $policy->is_active,
            'priority' => $policy->priority,
            'conditions' => $policy->conditions ?? [],
            'description' => $policy->description ?? '',
        ];

        $this->editingPolicyId = $policyId;
        $this->editMode = true;
        $this->showPolicyModal = true;
    }

    /**
     * å„²å­˜æ”¿ç­–
     */
    public function savePolicy(): void
    {
        $this->validate([
            'policyForm.name' => 'required|string|max:255',
            'policyForm.retention_days' => 'required|integer|min:1|max:3650',
            'policyForm.action' => 'required|in:delete,archive',
            'policyForm.priority' => 'required|integer|min:0|max:100',
        ], [
            'policyForm.name.required' => 'æ”¿ç­–åç¨±ç‚ºå¿…å¡«é …ç›®',
            'policyForm.retention_days.required' => 'ä¿ç•™å¤©æ•¸ç‚ºå¿…å¡«é …ç›®',
            'policyForm.retention_days.min' => 'ä¿ç•™å¤©æ•¸è‡³å°‘ç‚º 1 å¤©',
            'policyForm.retention_days.max' => 'ä¿ç•™å¤©æ•¸æœ€å¤šç‚º 3650 å¤©ï¼ˆ10å¹´ï¼‰',
            'policyForm.action.required' => 'è«‹é¸æ“‡è™•ç†å‹•ä½œ',
            'policyForm.priority.required' => 'å„ªå…ˆç´šç‚ºå¿…å¡«é …ç›®',
        ]);

        $data = $this->policyForm;
        $data['created_by'] = auth()->id();

        // æ¸…ç†ç©ºå€¼
        if (empty($data['activity_type'])) {
            $data['activity_type'] = null;
        }
        if (empty($data['module'])) {
            $data['module'] = null;
        }
        if (empty($data['conditions'])) {
            $data['conditions'] = null;
        }

        if ($this->editMode) {
            $policy = ActivityRetentionPolicy::findOrFail($this->editingPolicyId);
            $policy->update($data);
            $message = 'ä¿ç•™æ”¿ç­–å·²æ›´æ–°';
        } else {
            ActivityRetentionPolicy::create($data);
            $message = 'ä¿ç•™æ”¿ç­–å·²å»ºç«‹';
        }

        $this->showPolicyModal = false;
        $this->resetPolicyForm();
        
        $this->dispatch('policy-saved', message: $message);
        session()->flash('success', $message);
    }

    /**
     * åˆªé™¤æ”¿ç­–
     */
    public function deletePolicy(int $policyId): void
    {
        $policy = ActivityRetentionPolicy::findOrFail($policyId);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é—œè¯çš„æ¸…ç†æ—¥èªŒ
        if ($policy->cleanupLogs()->exists()) {
            session()->flash('error', 'ç„¡æ³•åˆªé™¤å·²æœ‰åŸ·è¡Œè¨˜éŒ„çš„æ”¿ç­–');
            return;
        }

        $policy->delete();
        
        $this->dispatch('policy-deleted', message: 'ä¿ç•™æ”¿ç­–å·²åˆªé™¤');
        session()->flash('success', 'ä¿ç•™æ”¿ç­–å·²åˆªé™¤');
    }

    /**
     * åˆ‡æ›æ”¿ç­–ç‹€æ…‹
     */
    public function togglePolicyStatus(int $policyId): void
    {
        $policy = ActivityRetentionPolicy::findOrFail($policyId);
        $policy->update(['is_active' => !$policy->is_active]);
        
        $status = $policy->is_active ? 'å•Ÿç”¨' : 'åœç”¨';
        $this->dispatch('policy-toggled', message: "æ”¿ç­–å·²{$status}");
    }

    /**
     * é è¦½æ”¿ç­–å½±éŸ¿
     */
    public function previewPolicy(int $policyId): void
    {
        $policy = ActivityRetentionPolicy::findOrFail($policyId);
        $this->previewData = $this->retentionService->previewPolicyImpact($policy);
        $this->showPreviewModal = true;
    }

    /**
     * åŸ·è¡Œæ”¿ç­–
     */
    public function executePolicy(int $policyId, bool $dryRun = false): void
    {
        try {
            $policy = ActivityRetentionPolicy::findOrFail($policyId);
            $result = $this->retentionService->executePolicy($policy, $dryRun);
            
            $message = $dryRun ? 'æ”¿ç­–é è¦½åŸ·è¡Œå®Œæˆ' : 'æ”¿ç­–åŸ·è¡Œå®Œæˆ';
            $message .= "ï¼Œè™•ç†äº† {$result['records_processed']} ç­†è¨˜éŒ„";
            
            $this->dispatch('policy-executed', message: $message);
            session()->flash('success', $message);
            
            // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
            $this->loadStats();
            
        } catch (\Exception $e) {
            $this->dispatch('policy-execution-failed', message: "æ”¿ç­–åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
            session()->flash('error', "æ”¿ç­–åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
        }
    }

    /**
     * åŸ·è¡Œæ‰€æœ‰æ”¿ç­–
     */
    public function executeAllPolicies(bool $dryRun = false): void
    {
        try {
            $results = $this->retentionService->executeAllPolicies($dryRun);
            
            $message = $dryRun ? 'æ‰€æœ‰æ”¿ç­–é è¦½åŸ·è¡Œå®Œæˆ' : 'æ‰€æœ‰æ”¿ç­–åŸ·è¡Œå®Œæˆ';
            $message .= "ï¼Œå…±è™•ç†äº† {$results['total_records_processed']} ç­†è¨˜éŒ„";
            
            $this->dispatch('policies-executed', message: $message);
            session()->flash('success', $message);
            
            // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
            $this->loadStats();
            
        } catch (\Exception $e) {
            $this->dispatch('policies-execution-failed', message: "æ”¿ç­–åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
            session()->flash('error', "æ”¿ç­–åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
        }
    }

    /**
     * é–‹å•Ÿæ‰‹å‹•æ¸…ç†æ¨¡æ…‹æ¡†
     */
    public function openCleanupModal(): void
    {
        $this->showCleanupModal = true;
    }

    /**
     * åŸ·è¡Œæ‰‹å‹•æ¸…ç†
     */
    public function executeManualCleanup(bool $dryRun = false): void
    {
        $this->validate([
            'cleanupForm.date_from' => 'required|date',
            'cleanupForm.date_to' => 'required|date|after_or_equal:cleanupForm.date_from',
            'cleanupForm.action' => 'required|in:delete,archive',
        ], [
            'cleanupForm.date_from.required' => 'é–‹å§‹æ—¥æœŸç‚ºå¿…å¡«é …ç›®',
            'cleanupForm.date_to.required' => 'çµæŸæ—¥æœŸç‚ºå¿…å¡«é …ç›®',
            'cleanupForm.date_to.after_or_equal' => 'çµæŸæ—¥æœŸå¿…é ˆå¤§æ–¼æˆ–ç­‰æ–¼é–‹å§‹æ—¥æœŸ',
            'cleanupForm.action.required' => 'è«‹é¸æ“‡è™•ç†å‹•ä½œ',
        ]);

        try {
            $criteria = array_filter($this->cleanupForm, function ($value) {
                return $value !== '' && $value !== null;
            });

            $result = $this->retentionService->manualCleanup(
                $criteria, 
                $this->cleanupForm['action'], 
                $dryRun
            );
            
            $message = $dryRun ? 'æ‰‹å‹•æ¸…ç†é è¦½å®Œæˆ' : 'æ‰‹å‹•æ¸…ç†åŸ·è¡Œå®Œæˆ';
            $message .= "ï¼Œè™•ç†äº† {$result['records_processed']} ç­†è¨˜éŒ„";
            
            $this->showCleanupModal = false;
            $this->dispatch('cleanup-executed', message: $message);
            session()->flash('success', $message);
            
            // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
            $this->loadStats();
            
        } catch (\Exception $e) {
            $this->dispatch('cleanup-execution-failed', message: "æ¸…ç†åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
            session()->flash('error', "æ¸…ç†åŸ·è¡Œå¤±æ•—: {$e->getMessage()}");
        }
    }

    /**
     * å»ºç«‹é è¨­æ”¿ç­–
     */
    public function createDefaultPolicies(): void
    {
        ActivityRetentionPolicy::createDefaultPolicies();
        
        $this->dispatch('default-policies-created', message: 'é è¨­ä¿ç•™æ”¿ç­–å·²å»ºç«‹');
        session()->flash('success', 'é è¨­ä¿ç•™æ”¿ç­–å·²å»ºç«‹');
    }

    /**
     * é‡è¨­æ”¿ç­–è¡¨å–®
     */
    protected function resetPolicyForm(): void
    {
        $this->policyForm = [
            'name' => '',
            'activity_type' => '',
            'module' => '',
            'retention_days' => 90,
            'action' => 'archive',
            'is_active' => true,
            'priority' => 1,
            'conditions' => [],
            'description' => '',
        ];
        $this->editingPolicyId = null;
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('retention-policy-form-reset');
    }

    /**
     * é—œé–‰æ¨¡æ…‹æ¡†
     */
    public function closeModal(): void
    {
        $this->showPolicyModal = false;
        $this->showCleanupModal = false;
        $this->showPreviewModal = false;
        $this->resetPolicyForm();
    }

    /**
     * ç›£è½äº‹ä»¶
     */
    #[On('policy-saved')]
    #[On('policy-deleted')]
    #[On('policy-toggled')]
    #[On('policy-executed')]
    #[On('policies-executed')]
    #[On('cleanup-executed')]
    #[On('default-policies-created')]
    public function refreshComponent(): void
    {
        // å…ƒä»¶æœƒè‡ªå‹•é‡æ–°æ¸²æŸ“
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.activities.retention-policy-manager', [
            'policies' => $this->policies,
            'cleanupLogs' => $this->cleanupLogs,
        ]);
    }
}