<?php

namespace App\Livewire\Admin\Activities;

use App\Livewire\Admin\AdminComponent;
use App\Models\Activity;
use App\Repositories\Contracts\ActivityRepositoryInterface;
use App\Services\ActivityExportService;
use Livewire\Attributes\On;
use Illuminate\Support\Facades\Storage;
use Carbon\Carbon;

/**
 * æ´»å‹•è¨˜éŒ„åŒ¯å‡ºå…ƒä»¶
 * 
 * æä¾›å¤šæ ¼å¼åŒ¯å‡ºã€ç¯„åœè¨­å®šã€æ‰¹é‡è™•ç†å’Œé€²åº¦è¿½è¹¤åŠŸèƒ½
 */
class ActivityExport extends AdminComponent
{
    /**
     * åŒ¯å‡ºæ ¼å¼é¸é …
     */
    public string $exportFormat = 'csv';
    public array $availableFormats = [
        'csv' => 'CSV (Excel ç›¸å®¹)',
        'json' => 'JSON (ç¨‹å¼è™•ç†)',
        'pdf' => 'PDF (å ±å‘Šåˆ—å°)'
    ];

    /**
     * åŒ¯å‡ºç¯„åœè¨­å®š
     */
    public string $dateFrom = '';
    public string $dateTo = '';
    public string $timeRange = '7d';
    public array $timeRangeOptions = [
        '1d' => 'æœ€è¿‘ 1 å¤©',
        '7d' => 'æœ€è¿‘ 7 å¤©',
        '30d' => 'æœ€è¿‘ 30 å¤©',
        '90d' => 'æœ€è¿‘ 90 å¤©',
        'custom' => 'è‡ªè¨‚ç¯„åœ'
    ];

    /**
     * ç¯©é¸æ¢ä»¶
     */
    public string $userFilter = '';
    public string $typeFilter = '';
    public string $moduleFilter = '';
    public string $resultFilter = '';
    public string $ipFilter = '';
    public string $riskLevelFilter = '';
    public bool $securityEventsOnly = false;

    /**
     * åŒ¯å‡ºé¸é …
     */
    public bool $includeUserDetails = true;
    public bool $includeProperties = true;
    public bool $includeRelatedData = false;
    public int $batchSize = 1000;
    public int $maxRecords = 10000;

    /**
     * é€²åº¦è¿½è¹¤
     */
    public bool $isExporting = false;
    public int $exportProgress = 0;
    public string $exportStatus = '';
    public ?string $exportJobId = null;
    public ?string $downloadUrl = null;
    public array $exportHistory = [];

    /**
     * çµ±è¨ˆè³‡è¨Š
     */
    public int $totalRecords = 0;
    public int $estimatedSize = 0;
    public string $estimatedTime = '';

    /**
     * ä¾è³´æ³¨å…¥
     */
    protected ActivityRepositoryInterface $activityRepository;
    protected ActivityExportService $exportService;

    /**
     * åˆå§‹åŒ–å…ƒä»¶
     */
    public function mount(): void
    {
        $this->authorize('activity_logs.export');
        
        // åˆå§‹åŒ–ä¾è³´æœå‹™
        $this->activityRepository = app(ActivityRepositoryInterface::class);
        $this->exportService = app(ActivityExportService::class);
        
        // è¨­å®šé è¨­æ—¥æœŸç¯„åœ
        $this->dateTo = now()->format('Y-m-d');
        $this->dateFrom = now()->subDays(7)->format('Y-m-d');
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        $this->updateStatistics();
        
        // è¼‰å…¥åŒ¯å‡ºæ­·å²ï¼ˆæ”¾åœ¨æœ€å¾Œï¼Œç¢ºä¿æœå‹™å·²åˆå§‹åŒ–ï¼‰
        $this->loadExportHistory();
    }

    /**
     * è¨ˆç®—å±¬æ€§ï¼šç¯©é¸æ¢ä»¶
     */
    public function getFiltersProperty(): array
    {
        $filters = [];

        // æ™‚é–“ç¯„åœ
        if ($this->timeRange === 'custom') {
            if ($this->dateFrom) {
                $filters['date_from'] = $this->dateFrom;
            }
            if ($this->dateTo) {
                $filters['date_to'] = $this->dateTo;
            }
        } else {
            $days = $this->parseDays($this->timeRange);
            $filters['date_from'] = now()->subDays($days)->format('Y-m-d');
            $filters['date_to'] = now()->format('Y-m-d');
        }

        // å…¶ä»–ç¯©é¸æ¢ä»¶
        if ($this->userFilter) {
            $filters['user_id'] = $this->userFilter;
        }
        if ($this->typeFilter) {
            $filters['type'] = $this->typeFilter;
        }
        if ($this->moduleFilter) {
            $filters['module'] = $this->moduleFilter;
        }
        if ($this->resultFilter) {
            $filters['result'] = $this->resultFilter;
        }
        if ($this->ipFilter) {
            $filters['ip_address'] = $this->ipFilter;
        }
        if ($this->riskLevelFilter) {
            $filters['risk_level'] = $this->riskLevelFilter;
        }
        if ($this->securityEventsOnly) {
            $filters['security_events_only'] = true;
        }

        return $filters;
    }

    /**
     * è¨ˆç®—å±¬æ€§ï¼šå¯ç”¨çš„ä½¿ç”¨è€…é¸é …
     */
    public function getUserOptionsProperty(): array
    {
        return Activity::with('user:id,username,name')
            ->whereNotNull('user_id')
            ->distinct('user_id')
            ->get()
            ->pluck('user.name', 'user_id')
            ->toArray();
    }

    /**
     * è¨ˆç®—å±¬æ€§ï¼šå¯ç”¨çš„é¡å‹é¸é …
     */
    public function getTypeOptionsProperty(): array
    {
        return Activity::distinct('type')
            ->whereNotNull('type')
            ->orderBy('type')
            ->pluck('type')
            ->mapWithKeys(fn($type) => [$type => $this->getTypeDisplayName($type)])
            ->toArray();
    }

    /**
     * è¨ˆç®—å±¬æ€§ï¼šå¯ç”¨çš„æ¨¡çµ„é¸é …
     */
    public function getModuleOptionsProperty(): array
    {
        return Activity::distinct('module')
            ->whereNotNull('module')
            ->orderBy('module')
            ->pluck('module')
            ->mapWithKeys(fn($module) => [$module => ucfirst($module)])
            ->toArray();
    }

    /**
     * æ›´æ–°æ™‚é–“ç¯„åœ
     */
    public function updatedTimeRange(): void
    {
        if ($this->timeRange !== 'custom') {
            $days = $this->parseDays($this->timeRange);
            $this->dateFrom = now()->subDays($days)->format('Y-m-d');
            $this->dateTo = now()->format('Y-m-d');
        }
        
        $this->updateStatistics();
    }

    /**
     * æ›´æ–°ç¯©é¸æ¢ä»¶æ™‚é‡æ–°è¨ˆç®—çµ±è¨ˆ
     */
    public function updated($propertyName): void
    {
        if (in_array($propertyName, [
            'dateFrom', 'dateTo', 'userFilter', 'typeFilter', 
            'moduleFilter', 'resultFilter', 'ipFilter', 
            'riskLevelFilter', 'securityEventsOnly'
        ])) {
            $this->updateStatistics();
        }
    }

    /**
     * é–‹å§‹åŒ¯å‡º
     */
    public function startExport(): void
    {
        $this->authorize('activity_logs.export');

        // é©—è­‰è¨­å®š
        if (!$this->validateExportSettings()) {
            return;
        }

        // æª¢æŸ¥è¨˜éŒ„æ•¸é‡é™åˆ¶
        if ($this->totalRecords > $this->maxRecords) {
            $this->dispatch('notify', [
                'type' => 'error',
                'message' => "åŒ¯å‡ºè¨˜éŒ„æ•¸é‡ ({$this->totalRecords}) è¶…éé™åˆ¶ ({$this->maxRecords})ï¼Œè«‹ç¸®å°ç¯„åœæˆ–ä½¿ç”¨ç¯©é¸æ¢ä»¶ã€‚"
            ]);
            return;
        }

        try {
            $this->isExporting = true;
            $this->exportProgress = 0;
            $this->exportStatus = 'æº–å‚™åŒ¯å‡º...';
            $this->downloadUrl = null;

            // å»ºç«‹åŒ¯å‡ºå·¥ä½œ
            $exportConfig = [
                'format' => $this->exportFormat,
                'filters' => $this->filters,
                'options' => [
                    'include_user_details' => $this->includeUserDetails,
                    'include_properties' => $this->includeProperties,
                    'include_related_data' => $this->includeRelatedData,
                    'batch_size' => $this->batchSize,
                ],
                'user_id' => auth()->id(),
            ];

            if ($this->totalRecords <= $this->batchSize) {
                // å°é‡è³‡æ–™ç›´æ¥åŒ¯å‡º
                $this->performDirectExport($exportConfig);
            } else {
                // å¤§é‡è³‡æ–™ä½¿ç”¨ä½‡åˆ—åŒ¯å‡º
                $this->performBatchExport($exportConfig);
            }

        } catch (\Exception $e) {
            $this->handleExportError($e);
        }
    }

    /**
     * å–æ¶ˆåŒ¯å‡º
     */
    public function cancelExport(): void
    {
        if ($this->exportJobId) {
            $this->exportService->cancelExport($this->exportJobId);
        }

        $this->resetExportState();
        
        $this->dispatch('notify', [
            'type' => 'info',
            'message' => 'åŒ¯å‡ºå·²å–æ¶ˆ'
        ]);
    }

    /**
     * ä¸‹è¼‰åŒ¯å‡ºæª”æ¡ˆ
     */
    public function downloadExport(): void
    {
        if (!$this->downloadUrl) {
            $this->dispatch('notify', [
                'type' => 'error',
                'message' => 'ä¸‹è¼‰é€£çµä¸å­˜åœ¨'
            ]);
            return;
        }

        $this->dispatch('download-file', url: $this->downloadUrl);
        
        // è¨˜éŒ„ä¸‹è¼‰æ“ä½œ
        Activity::log('download_export', 'ä¸‹è¼‰æ´»å‹•è¨˜éŒ„åŒ¯å‡ºæª”æ¡ˆ', [
            'module' => 'activities',
            'properties' => [
                'format' => $this->exportFormat,
                'download_url' => $this->downloadUrl,
            ],
        ]);
    }

    /**
     * æ¸…é™¤åŒ¯å‡ºæ­·å²
     */
    public function clearExportHistory(): void
    {
        $this->exportService->clearUserExportHistory(auth()->id());
        $this->loadExportHistory();
        
        $this->dispatch('notify', [
            'type' => 'success',
            'message' => 'åŒ¯å‡ºæ­·å²å·²æ¸…é™¤'
        ]);
    }

    /**
     * é‡è¨­ç¯©é¸æ¢ä»¶ - ä¿®å¾©ç‰ˆæœ¬
     */
    public function resetFilters(): void
    {
        \Log::info('ğŸ”¥ ActivityExport resetFilters - æ–¹æ³•è¢«å‘¼å«äº†ï¼', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
            'before_reset' => [
                'userFilter' => $this->userFilter,
                'typeFilter' => $this->typeFilter,
                'moduleFilter' => $this->moduleFilter,
                'resultFilter' => $this->resultFilter,
                'ipFilter' => $this->ipFilter,
                'riskLevelFilter' => $this->riskLevelFilter,
                'securityEventsOnly' => $this->securityEventsOnly,
                'timeRange' => $this->timeRange,
            ]
        ]);
        
        // é‡ç½®æ‰€æœ‰ç¯©é¸æ¢ä»¶
        $this->userFilter = '';
        $this->typeFilter = '';
        $this->moduleFilter = '';
        $this->resultFilter = '';
        $this->ipFilter = '';
        $this->riskLevelFilter = '';
        $this->securityEventsOnly = false;
        $this->timeRange = '7d';
        
        // é‡ç½®åŒ¯å‡ºé¸é …
        $this->includeUserDetails = true;
        $this->includeProperties = true;
        $this->includeRelatedData = false;
        
        // æ›´æ–°æ™‚é–“ç¯„åœå’Œçµ±è¨ˆ
        $this->updatedTimeRange();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('activity-export-reset');
        
        \Log::info('ğŸ”¥ ActivityExport resetFilters - å±¬æ€§å·²é‡ç½®', [
            'after_reset' => [
                'userFilter' => $this->userFilter,
                'typeFilter' => $this->typeFilter,
                'moduleFilter' => $this->moduleFilter,
                'resultFilter' => $this->resultFilter,
                'ipFilter' => $this->ipFilter,
                'riskLevelFilter' => $this->riskLevelFilter,
                'securityEventsOnly' => $this->securityEventsOnly,
                'timeRange' => $this->timeRange,
            ]
        ]);
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        $this->dispatch('notify', [
            'type' => 'success',
            'message' => 'åŒ¯å‡ºç¯©é¸æ¢ä»¶å·²é‡ç½®'
        ]);
        
        \Log::info('ğŸ”¥ ActivityExport resetFilters - ä¿®å¾©ç‰ˆæœ¬åŸ·è¡Œå®Œæˆ');
    }

    /**
     * ç›£è½åŒ¯å‡ºé€²åº¦æ›´æ–°
     */
    #[On('export-progress-updated')]
    public function updateExportProgress(array $data): void
    {
        if ($data['job_id'] === $this->exportJobId) {
            $this->exportProgress = $data['progress'];
            $this->exportStatus = $data['status'];
            
            if ($data['completed']) {
                $this->exportCompleted($data);
            }
        }
    }

    /**
     * ç›£è½åŒ¯å‡ºå®Œæˆ
     */
    #[On('export-completed')]
    public function exportCompleted(array $data): void
    {
        if ($data['job_id'] === $this->exportJobId) {
            $this->isExporting = false;
            $this->exportProgress = 100;
            $this->exportStatus = 'åŒ¯å‡ºå®Œæˆ';
            $this->downloadUrl = $data['download_url'];
            
            $this->loadExportHistory();
            
            $this->dispatch('notify', [
                'type' => 'success',
                'message' => 'åŒ¯å‡ºå®Œæˆï¼Œå¯ä»¥ä¸‹è¼‰æª”æ¡ˆ'
            ]);
        }
    }

    /**
     * ç›£è½åŒ¯å‡ºå¤±æ•—
     */
    #[On('export-failed')]
    public function exportFailed(array $data): void
    {
        if ($data['job_id'] === $this->exportJobId) {
            $this->handleExportError(new \Exception($data['error']));
        }
    }

    /**
     * åŸ·è¡Œç›´æ¥åŒ¯å‡ºï¼ˆå°é‡è³‡æ–™ï¼‰
     */
    protected function performDirectExport(array $config): void
    {
        $this->exportStatus = 'æ­£åœ¨åŒ¯å‡ºè³‡æ–™...';
        
        // ç¢ºä¿æœå‹™å·²åˆå§‹åŒ–
        if (!isset($this->exportService)) {
            $this->exportService = app(ActivityExportService::class);
        }
        
        $result = $this->exportService->exportDirect($config);
        
        $this->isExporting = false;
        $this->exportProgress = 100;
        $this->exportStatus = 'åŒ¯å‡ºå®Œæˆ';
        $this->downloadUrl = $result['download_url'];
        
        $this->loadExportHistory();
        
        $this->dispatch('notify', [
            'type' => 'success',
            'message' => 'åŒ¯å‡ºå®Œæˆ'
        ]);
    }

    /**
     * åŸ·è¡Œæ‰¹é‡åŒ¯å‡ºï¼ˆå¤§é‡è³‡æ–™ï¼‰
     */
    protected function performBatchExport(array $config): void
    {
        $this->exportStatus = 'å»ºç«‹åŒ¯å‡ºå·¥ä½œ...';
        
        $jobId = $this->exportService->exportBatch($config);
        $this->exportJobId = $jobId;
        
        $this->exportStatus = 'æ­£åœ¨ä½‡åˆ—ä¸­ç­‰å¾…è™•ç†...';
    }

    /**
     * è™•ç†åŒ¯å‡ºéŒ¯èª¤
     */
    protected function handleExportError(\Exception $e): void
    {
        $this->resetExportState();
        
        $this->dispatch('notify', [
            'type' => 'error',
            'message' => 'åŒ¯å‡ºå¤±æ•—ï¼š' . $e->getMessage()
        ]);
        
        // è¨˜éŒ„éŒ¯èª¤
        Activity::log('export_failed', 'æ´»å‹•è¨˜éŒ„åŒ¯å‡ºå¤±æ•—', [
            'module' => 'activities',
            'properties' => [
                'error' => $e->getMessage(),
                'format' => $this->exportFormat,
                'filters' => $this->filters,
            ],
        ]);
    }

    /**
     * é‡è¨­åŒ¯å‡ºç‹€æ…‹
     */
    protected function resetExportState(): void
    {
        $this->isExporting = false;
        $this->exportProgress = 0;
        $this->exportStatus = '';
        $this->exportJobId = null;
        $this->downloadUrl = null;
    }

    /**
     * é©—è­‰åŒ¯å‡ºè¨­å®š
     */
    protected function validateExportSettings(): bool
    {
        // æª¢æŸ¥æ—¥æœŸç¯„åœ
        if ($this->timeRange === 'custom') {
            if (!$this->dateFrom || !$this->dateTo) {
                $this->dispatch('notify', [
                    'type' => 'error',
                    'message' => 'è«‹é¸æ“‡æœ‰æ•ˆçš„æ—¥æœŸç¯„åœ'
                ]);
                return false;
            }
            
            if (Carbon::parse($this->dateFrom) > Carbon::parse($this->dateTo)) {
                $this->dispatch('notify', [
                    'type' => 'error',
                    'message' => 'é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ'
                ]);
                return false;
            }
        }

        // æª¢æŸ¥åŒ¯å‡ºæ ¼å¼
        if (!in_array($this->exportFormat, array_keys($this->availableFormats))) {
            $this->dispatch('notify', [
                'type' => 'error',
                'message' => 'ä¸æ”¯æ´çš„åŒ¯å‡ºæ ¼å¼'
            ]);
            return false;
        }

        return true;
    }

    /**
     * æ›´æ–°çµ±è¨ˆè³‡è¨Š
     */
    protected function updateStatistics(): void
    {
        try {
            $query = Activity::query();
            $this->applyFiltersToQuery($query, $this->filters);
            
            $this->totalRecords = $query->count();
            $this->estimatedSize = $this->calculateEstimatedSize();
            $this->estimatedTime = $this->calculateEstimatedTime();
            
        } catch (\Exception $e) {
            $this->totalRecords = 0;
            $this->estimatedSize = 0;
            $this->estimatedTime = '';
        }
    }

    /**
     * è¼‰å…¥åŒ¯å‡ºæ­·å²
     */
    protected function loadExportHistory(): void
    {
        $this->exportHistory = $this->exportService->getUserExportHistory(auth()->id(), 10);
    }

    /**
     * æ‡‰ç”¨ç¯©é¸æ¢ä»¶åˆ°æŸ¥è©¢
     */
    protected function applyFiltersToQuery($query, array $filters): void
    {
        if (!empty($filters['date_from'])) {
            $query->where('created_at', '>=', Carbon::parse($filters['date_from'])->startOfDay());
        }
        
        if (!empty($filters['date_to'])) {
            $query->where('created_at', '<=', Carbon::parse($filters['date_to'])->endOfDay());
        }
        
        if (!empty($filters['user_id'])) {
            $query->where('user_id', $filters['user_id']);
        }
        
        if (!empty($filters['type'])) {
            $query->where('type', $filters['type']);
        }
        
        if (!empty($filters['module'])) {
            $query->where('module', $filters['module']);
        }
        
        if (!empty($filters['result'])) {
            $query->where('result', $filters['result']);
        }
        
        if (!empty($filters['ip_address'])) {
            $query->where('ip_address', 'like', "%{$filters['ip_address']}%");
        }
        
        if (!empty($filters['risk_level'])) {
            if ($filters['risk_level'] === 'high') {
                $query->where('risk_level', '>=', 7);
            } else {
                $query->where('risk_level', $filters['risk_level']);
            }
        }
        
        if (!empty($filters['security_events_only'])) {
            $query->where('risk_level', '>=', 5);
        }
    }

    /**
     * è¨ˆç®—é ä¼°æª”æ¡ˆå¤§å°
     */
    protected function calculateEstimatedSize(): int
    {
        if ($this->totalRecords === 0) {
            return 0;
        }

        // æ ¹æ“šæ ¼å¼å’Œé¸é …ä¼°ç®—æ¯ç­†è¨˜éŒ„çš„å¤§å°ï¼ˆä½å…ƒçµ„ï¼‰
        $bytesPerRecord = match ($this->exportFormat) {
            'csv' => 200,
            'json' => $this->includeProperties ? 800 : 400,
            'pdf' => 300,
            default => 300,
        };

        if ($this->includeUserDetails) {
            $bytesPerRecord += 100;
        }

        if ($this->includeRelatedData) {
            $bytesPerRecord += 200;
        }

        return $this->totalRecords * $bytesPerRecord;
    }

    /**
     * è¨ˆç®—é ä¼°è™•ç†æ™‚é–“
     */
    protected function calculateEstimatedTime(): string
    {
        if ($this->totalRecords === 0) {
            return '0 ç§’';
        }

        // ä¼°ç®—æ¯ç§’å¯è™•ç†çš„è¨˜éŒ„æ•¸
        $recordsPerSecond = match ($this->exportFormat) {
            'csv' => 1000,
            'json' => 500,
            'pdf' => 100,
            default => 500,
        };

        $seconds = ceil($this->totalRecords / $recordsPerSecond);

        if ($seconds < 60) {
            return "{$seconds} ç§’";
        } elseif ($seconds < 3600) {
            $minutes = ceil($seconds / 60);
            return "{$minutes} åˆ†é˜";
        } else {
            $hours = ceil($seconds / 3600);
            return "{$hours} å°æ™‚";
        }
    }

    /**
     * è§£ææ™‚é–“ç¯„åœç‚ºå¤©æ•¸
     */
    protected function parseDays(string $timeRange): int
    {
        return match ($timeRange) {
            '1d' => 1,
            '7d' => 7,
            '30d' => 30,
            '90d' => 90,
            default => 7,
        };
    }

    /**
     * å–å¾—é¡å‹é¡¯ç¤ºåç¨±
     */
    protected function getTypeDisplayName(string $type): string
    {
        return match ($type) {
            'login' => 'ç™»å…¥',
            'logout' => 'ç™»å‡º',
            'create_user' => 'å»ºç«‹ä½¿ç”¨è€…',
            'update_user' => 'æ›´æ–°ä½¿ç”¨è€…',
            'delete_user' => 'åˆªé™¤ä½¿ç”¨è€…',
            'create_role' => 'å»ºç«‹è§’è‰²',
            'update_role' => 'æ›´æ–°è§’è‰²',
            'delete_role' => 'åˆªé™¤è§’è‰²',
            'assign_role' => 'æŒ‡æ´¾è§’è‰²',
            'remove_role' => 'ç§»é™¤è§’è‰²',
            'create_permission' => 'å»ºç«‹æ¬Šé™',
            'update_permission' => 'æ›´æ–°æ¬Šé™',
            'delete_permission' => 'åˆªé™¤æ¬Šé™',
            'view_dashboard' => 'æª¢è¦–å„€è¡¨æ¿',
            'export_data' => 'åŒ¯å‡ºè³‡æ–™',
            'system_setting' => 'ç³»çµ±è¨­å®š',
            'security_event' => 'å®‰å…¨äº‹ä»¶',
            default => $type,
        };
    }

    /**
     * æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
     */
    public function formatFileSize(int $bytes): string
    {
        if ($bytes === 0) {
            return '0 B';
        }

        $units = ['B', 'KB', 'MB', 'GB'];
        $factor = floor(log($bytes, 1024));
        
        return sprintf('%.1f %s', $bytes / pow(1024, $factor), $units[$factor]);
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.activities.activity-export');
    }
}