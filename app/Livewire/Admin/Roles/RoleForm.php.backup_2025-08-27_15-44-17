<?php

namespace App\Livewire\Admin\Roles;

use App\Livewire\Admin\AdminComponent;
use App\Models\Role;
use App\Repositories\Contracts\RoleRepositoryInterface;
use App\Services\RoleSecurityService;
use App\Services\RoleDataValidationService;
use App\Services\AuditLogService;
use Illuminate\Validation\Rule;
use Illuminate\Validation\ValidationException;
use Livewire\Attributes\On;

/**
 * è§’è‰²è¡¨å–®å…ƒä»¶
 * 
 * æä¾›è§’è‰²å»ºç«‹å’Œç·¨è¼¯åŠŸèƒ½ï¼ŒåŒ…å«è³‡æ–™é©—è­‰å’Œç³»çµ±è§’è‰²ä¿è­·æ©Ÿåˆ¶
 */
class RoleForm extends AdminComponent
{
    // è§’è‰²è³‡æ–™å±¬æ€§
    public ?Role $role = null;
    public string $name = '';
    public string $display_name = '';
    public string $description = '';
    public ?int $parent_id = null;
    public bool $is_active = true;
    
    // è¡¨å–®ç‹€æ…‹å±¬æ€§
    public bool $isEditing = false;
    public bool $showParentSelector = false;
    public bool $isSystemRole = false;
    public bool $autoSaveEnabled = true;
    public bool $hasUnsavedChanges = false;
    public ?string $lastAutoSaveTime = null;
    
    // å¯é¸çˆ¶è§’è‰²åˆ—è¡¨
    public array $availableParents = [];

    protected RoleRepositoryInterface $roleRepository;
    protected RoleSecurityService $securityService;
    protected RoleDataValidationService $validationService;
    protected AuditLogService $auditLogService;

    /**
     * å…ƒä»¶åˆå§‹åŒ–
     */
    public function boot(
        RoleRepositoryInterface $roleRepository,
        RoleSecurityService $securityService,
        RoleDataValidationService $validationService,
        AuditLogService $auditLogService
    ): void {
        $this->roleRepository = $roleRepository;
        $this->securityService = $securityService;
        $this->validationService = $validationService;
        $this->auditLogService = $auditLogService;
    }

    /**
     * å…ƒä»¶æŽ›è¼‰
     */
    public function mount($role = null): void
    {
        // å…ˆèª¿ç”¨çˆ¶é¡žçš„ mount æ–¹æ³•
        parent::mount();
        
        if ($role && $role instanceof Role) {
            $this->checkPermission('roles.edit');
            $this->isEditing = true;
            $this->role = $role;
            $this->loadRoleData();
        } else {
            $this->checkPermission('roles.create');
            $this->isEditing = false;
            $this->role = null;
        }
        
        $this->loadAvailableParents();
    }

    /**
     * è¼‰å…¥è§’è‰²è³‡æ–™
     */
    private function loadRoleData(): void
    {
        $this->name = $this->role->name ?? '';
        $this->display_name = $this->role->display_name ?? '';
        $this->description = $this->role->description ?? '';
        $this->parent_id = $this->role->parent_id;
        $this->is_active = $this->role->is_active ?? true;
        $this->isSystemRole = $this->role->is_system_role ?? false;
    }

    /**
     * è¼‰å…¥å¯é¸çš„çˆ¶è§’è‰²åˆ—è¡¨
     */
    private function loadAvailableParents(): void
    {
        $query = Role::where('is_active', true);
        
        // ç·¨è¼¯æ¨¡å¼æ™‚æŽ’é™¤è‡ªå·±å’Œè‡ªå·±çš„å¾Œä»£
        if ($this->isEditing && $this->role) {
            $excludeIds = [$this->role->id];
            $descendants = $this->role->getDescendants();
            $excludeIds = array_merge($excludeIds, $descendants->pluck('id')->toArray());
            $query->whereNotIn('id', $excludeIds);
        }
        
        $this->availableParents = $query->orderBy('display_name')
                                       ->get(['id', 'display_name', 'name'])
                                       ->toArray();
    }

    /**
     * é©—è­‰è¦å‰‡
     */
    protected function rules(): array
    {
        $rules = [
            'display_name' => ['required', 'string', 'max:50'],
            'description' => ['nullable', 'string', 'max:255'],
            'parent_id' => ['nullable', 'exists:roles,id'],
            'is_active' => ['boolean'],
        ];

        // ç³»çµ±è§’è‰²ä¸èƒ½ä¿®æ”¹åç¨±
        if (!$this->isSystemRole) {
            $rules['name'] = [
                'required',
                'string',
                'max:50',
                'regex:/^[a-z_]+$/',
                Rule::unique('roles')->ignore($this->role?->id)
            ];
        }

        return $rules;
    }

    /**
     * é©—è­‰è¨Šæ¯
     */
    protected function messages(): array
    {
        return [
            'name.required' => 'è§’è‰²åç¨±ç‚ºå¿…å¡«é …ç›®',
            'name.unique' => 'è§’è‰²åç¨±å·²å­˜åœ¨',
            'name.regex' => 'è§’è‰²åç¨±åªèƒ½åŒ…å«å°å¯«è‹±æ–‡å­—æ¯å’Œåº•ç·š',
            'name.max' => 'è§’è‰²åç¨±ä¸èƒ½è¶…éŽ 50 å€‹å­—å…ƒ',
            'display_name.required' => 'é¡¯ç¤ºåç¨±ç‚ºå¿…å¡«é …ç›®',
            'display_name.max' => 'é¡¯ç¤ºåç¨±ä¸èƒ½è¶…éŽ 50 å€‹å­—å…ƒ',
            'description.max' => 'è§’è‰²æè¿°ä¸èƒ½è¶…éŽ 255 å€‹å­—å…ƒ',
            'parent_id.exists' => 'é¸æ“‡çš„çˆ¶è§’è‰²ä¸å­˜åœ¨',
        ];
    }

    /**
     * å³æ™‚é©—è­‰å±¬æ€§
     */
    protected function validationAttributes(): array
    {
        return [
            'name' => 'è§’è‰²åç¨±',
            'display_name' => 'é¡¯ç¤ºåç¨±',
            'description' => 'è§’è‰²æè¿°',
            'parent_id' => 'çˆ¶è§’è‰²',
            'is_active' => 'å•Ÿç”¨ç‹€æ…‹',
        ];
    }

    /**
     * åç¨±æ¬„ä½æ›´æ–°æ™‚çš„è™•ç†
     */
    public function updatedName(): void
    {
        if (!$this->isSystemRole) {
            $this->validateOnly('name');
        }
        $this->markAsChanged();
    }

    /**
     * é¡¯ç¤ºåç¨±æ¬„ä½æ›´æ–°æ™‚çš„è™•ç†
     */
    public function updatedDisplayName(): void
    {
        $this->validateOnly('display_name');
        
        // å¦‚æžœæ˜¯æ–°å»ºè§’è‰²ä¸”åç¨±ç‚ºç©ºï¼Œè‡ªå‹•ç”Ÿæˆåç¨±
        if (!$this->isEditing && empty($this->name) && !$this->isSystemRole) {
            $this->name = $this->generateNameFromDisplayName($this->display_name);
        }
        
        $this->markAsChanged();
    }

    /**
     * çˆ¶è§’è‰²é¸æ“‡æ›´æ–°æ™‚çš„è™•ç†
     */
    public function updatedParentId(): void
    {
        if ($this->parent_id) {
            $this->validateOnly('parent_id');
            
            // æª¢æŸ¥å¾ªç’°ä¾è³´
            if ($this->isEditing && $this->role && $this->role->hasCircularDependency($this->parent_id)) {
                $this->addError('parent_id', 'ä¸èƒ½é¸æ“‡æœƒé€ æˆå¾ªç’°ä¾è³´çš„çˆ¶è§’è‰²');
                $this->parent_id = null;
                return;
            }
            
            // é è¦½æ¬Šé™ç¹¼æ‰¿è®Šæ›´
            $this->previewPermissionInheritance();
        }
        
        $this->markAsChanged();
    }

    /**
     * é è¦½æ¬Šé™ç¹¼æ‰¿è®Šæ›´
     */
    private function previewPermissionInheritance(): void
    {
        if (!$this->parent_id) {
            return;
        }
        
        try {
            $parentRole = Role::find($this->parent_id);
            if ($parentRole) {
                $inheritedPermissions = $parentRole->getAllPermissions();
                $this->dispatch('permission-inheritance-preview', [
                    'parentName' => $parentRole->display_name,
                    'inheritedCount' => $inheritedPermissions->count(),
                    'inheritedPermissions' => $inheritedPermissions->pluck('name')->toArray()
                ]);
            }
        } catch (\Exception $e) {
            // éœé»˜è™•ç†é è¦½éŒ¯èª¤
        }
    }

    /**
     * å¾žé¡¯ç¤ºåç¨±ç”Ÿæˆè§’è‰²åç¨±
     */
    private function generateNameFromDisplayName(string $displayName): string
    {
        // ç§»é™¤ç‰¹æ®Šå­—å…ƒï¼Œè½‰æ›ç‚ºå°å¯«ä¸¦ç”¨åº•ç·šé€£æŽ¥
        $name = strtolower(trim($displayName));
        // ç§»é™¤éžè‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œç©ºæ ¼çš„å­—å…ƒ
        $name = preg_replace('/[^\p{L}\p{N}\s]/u', '', $name);
        // å°‡ä¸­æ–‡ç­‰éžASCIIå­—å…ƒè½‰æ›ç‚ºæ‹¼éŸ³æˆ–ç§»é™¤
        $name = preg_replace('/[^\x00-\x7F]/', '', $name);
        // å°‡å¤šå€‹ç©ºæ ¼æ›¿æ›ç‚ºå–®å€‹åº•ç·š
        $name = preg_replace('/\s+/', '_', $name);
        // ç§»é™¤é–‹é ­å’Œçµå°¾çš„åº•ç·š
        $name = trim($name, '_');
        
        return $name ?: 'role_' . time();
    }

    /**
     * åˆ‡æ›çˆ¶è§’è‰²é¸æ“‡å™¨é¡¯ç¤º
     */
    public function toggleParentSelector(): void
    {
        $this->showParentSelector = !$this->showParentSelector;
        
        if (!$this->showParentSelector) {
            $this->parent_id = null;
        }
    }

    /**
     * å„²å­˜è§’è‰²
     */
    public function save(): void
    {
        try {
            // æº–å‚™è³‡æ–™
            $data = [
                'display_name' => $this->display_name,
                'description' => $this->description,
                'parent_id' => $this->parent_id,
                'is_active' => $this->is_active,
            ];

            // åªæœ‰éžç³»çµ±è§’è‰²æ‰èƒ½ä¿®æ”¹åç¨±
            if (!$this->isSystemRole) {
                $data['name'] = $this->name;
            }

            // åŸ·è¡Œå¤šå±¤ç´šå®‰å…¨æª¢æŸ¥
            $action = $this->isEditing ? 'edit' : 'create';
            $securityCheck = $this->securityService->checkMultiLevelPermissions($action, $this->role);
            
            if (!$securityCheck['allowed']) {
                $this->addError('save', $securityCheck['message']);
                return;
            }

            // é©—è­‰å’Œæ¸…ç†è³‡æ–™
            if ($this->isEditing) {
                $validatedData = $this->validationService->validateRoleUpdateData($data, $this->role);
            } else {
                $validatedData = $this->validationService->validateRoleCreationData($data);
            }

            if ($this->isEditing) {
                $oldData = $this->role->toArray();
                $oldParentId = $this->role->parent_id;
                
                $this->roleRepository->update($this->role, $validatedData);
                
                // è¨˜éŒ„æ›´æ–°æ“ä½œ
                $this->securityService->logRoleOperation('update', $this->role, [
                    'old_data' => $oldData,
                    'new_data' => $validatedData,
                    'parent_changed' => $oldParentId !== $this->parent_id
                ]);
                
                // å¦‚æžœçˆ¶è§’è‰²æœ‰è®Šæ›´ï¼Œæ›´æ–°æ¬Šé™ç¹¼æ‰¿
                if ($oldParentId !== $this->parent_id) {
                    $this->updatePermissionInheritance();
                }
                
                // é‡ç½®æœªå„²å­˜è®Šæ›´æ¨™è¨˜
                $this->hasUnsavedChanges = false;
                $this->lastAutoSaveTime = null;
                
                $message = "è§’è‰²ã€Œ{$this->display_name}ã€å·²æˆåŠŸæ›´æ–°";
                
                $this->dispatch('role-updated', [
                    'roleId' => $this->role->id,
                    'message' => $message,
                    'parentChanged' => $oldParentId !== $this->parent_id
                ]);
            } else {
                $validatedData['is_system_role'] = false; // æ–°å»ºè§’è‰²é è¨­ä¸æ˜¯ç³»çµ±è§’è‰²
                $newRole = $this->roleRepository->create($validatedData);
                
                // è¨˜éŒ„å»ºç«‹æ“ä½œ
                $this->securityService->logRoleOperation('create', $newRole, $validatedData);
                
                $message = "è§’è‰²ã€Œ{$this->display_name}ã€å·²æˆåŠŸå»ºç«‹";
                
                $this->dispatch('role-created', [
                    'roleId' => $newRole->id,
                    'message' => $message
                ]);
                
                // å»ºç«‹æˆåŠŸå¾Œè·³è½‰åˆ°æ¬Šé™è¨­å®šé é¢
                $this->redirectToPermissionMatrix($newRole->id);
            }

        } catch (ValidationException $e) {
            foreach ($e->errors() as $field => $messages) {
                foreach ($messages as $message) {
                    $this->addError($field, $message);
                }
            }
        } catch (\Exception $e) {
            $this->addError('save', 'å„²å­˜å¤±æ•—ï¼š' . $e->getMessage());
            
            // è¨˜éŒ„éŒ¯èª¤
            $this->auditLogService->logSecurityEvent('role_save_failed', 'medium', [
                'action' => $this->isEditing ? 'update' : 'create',
                'role_id' => $this->role?->id,
                'data' => $data,
                'error' => $e->getMessage()
            ]);
        }
    }

    /**
     * ç³»çµ±è§’è‰²ä¿è­·æª¢æŸ¥
     */
    private function checkSystemRoleProtection(): void
    {
        $originalRole = $this->roleRepository->findOrFail($this->role->id);
        
        // æª¢æŸ¥æ˜¯å¦å˜—è©¦ä¿®æ”¹å—ä¿è­·çš„å±¬æ€§
        if ($this->name !== $originalRole->name) {
            throw new \Exception('ç³»çµ±è§’è‰²çš„åç¨±ä¸èƒ½ä¿®æ”¹');
        }
        
        // æŸäº›æ ¸å¿ƒç³»çµ±è§’è‰²ä¸èƒ½åœç”¨
        $protectedRoles = ['super_admin', 'admin'];
        if (in_array($originalRole->name, $protectedRoles) && !$this->is_active) {
            throw new \Exception('æ ¸å¿ƒç³»çµ±è§’è‰²ä¸èƒ½åœç”¨');
        }
    }

    /**
     * è·³è½‰åˆ°æ¬Šé™çŸ©é™£é é¢
     */
    private function redirectToPermissionMatrix(int $roleId): void
    {
        $this->dispatch('redirect-to-permissions', roleId: $roleId);
    }

    /**
     * å–æ¶ˆæ“ä½œ
     */
    public function cancel()
    {
        $this->dispatch('role-form-cancelled');
        return $this->redirect(route('admin.roles.index'));
    
        $this->resetValidation();
    }

    /**
     * é‡ç½®è¡¨å–®
     */
    public function resetForm(): void
    {
        try {
        // è¨˜éŒ„è¡¨å–®é‡ç½®æ“ä½œ
        \Log::info('ðŸ”„ resetForm - æ¨¡æ…‹è¡¨å–®é‡ç½®é–‹å§‹', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
            'modal_component' => static::class,
        ]);
        
        // é‡ç½®æ‰€æœ‰è¡¨å–®æ¬„ä½å’Œæ¨¡æ…‹ç‹€æ…‹
        $this->name = '';
        $this->display_name = false;
        $this->description = '';
        $this->parent_id = '';
        $this->is_active = false;
        $this->isEditing = false;
        $this->showParentSelector = false;
        $this->isSystemRole = false;
        $this->autoSaveEnabled = '';
        $this->hasUnsavedChanges = '';
        $this->lastAutoSaveTime = '';
        $this->availableParents = '';
        $this->showModal = false;
        $this->isOpen = false;
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€è¡¨å–®é‡ç½®å®Œæˆäº‹ä»¶
        $this->dispatch('resetForm-completed');
        $this->dispatch('modal-form-reset');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… resetForm - æ¨¡æ…‹è¡¨å–®é‡ç½®å®Œæˆ');

        
        $this->resetValidation('name');
    
        $this->resetValidation('description');
    
        $this->resetValidation('name');
    
        $this->resetValidation('description');
    } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'resetForm',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * ç¢ºèªé‡ç½®è¡¨å–®
     */
    public function confirmResetForm(): void
    {
        if ($this->hasUnsavedChanges) {
            $this->dispatch('confirm-form-reset');
        } else {
            $this->resetForm();
        }
    }

    /**
     * è¤‡è£½è§’è‰²åŠŸèƒ½
     */
    public function duplicateRole(): void
    {
        if (!$this->isEditing) {
            return;
        }

        $this->checkPermission('roles.create');

        try {
            $newName = $this->role->name . '_copy_' . time();
            $duplicatedRole = $this->roleRepository->duplicateRole($this->role, $newName);
            
            $this->dispatch('role-duplicated', [
                'roleId' => $duplicatedRole->id,
                'message' => "è§’è‰²ã€Œ{$this->role->display_name}ã€å·²æˆåŠŸè¤‡è£½ç‚ºã€Œ{$duplicatedRole->display_name}ã€"
            ]);
            
            // è·³è½‰åˆ°æ–°è§’è‰²çš„ç·¨è¼¯é é¢
            $this->dispatch('redirect-to-edit', roleId: $duplicatedRole->id);
            
        } catch (\Exception $e) {
            $this->addError('duplicate', 'è¤‡è£½å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * æª¢æŸ¥åç¨±æ˜¯å¦å¯ç”¨
     */
    public function checkNameAvailability(): void
    {
        if (empty($this->name) || $this->isSystemRole) {
            return;
        }

        $exists = $this->roleRepository->nameExists($this->name, $this->role?->id);
        
        if ($exists) {
            $this->addError('name', 'è§’è‰²åç¨±å·²å­˜åœ¨');
        } else {
            $this->resetErrorBag('name');
        }
    }

    /**
     * å–å¾—è¡¨å–®æ¨™é¡Œ
     */
    public function getFormTitleProperty(): string
    {
        return $this->isEditing ? "ç·¨è¼¯è§’è‰²ï¼š{$this->role->display_name}" : 'å»ºç«‹æ–°è§’è‰²';
    }

    /**
     * å–å¾—å„²å­˜æŒ‰éˆ•æ–‡å­—
     */
    public function getSaveButtonTextProperty(): string
    {
        return $this->isEditing ? 'æ›´æ–°è§’è‰²' : 'å»ºç«‹è§’è‰²';
    }

    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹çˆ¶è§’è‰²
     */
    public function getCanModifyParentProperty(): bool
    {
        // ç³»çµ±è§’è‰²ä¸èƒ½ä¿®æ”¹å±¤ç´šé—œä¿‚
        if ($this->isSystemRole) {
            return false;
        }
        
        // å¦‚æžœè§’è‰²æœ‰å­è§’è‰²ï¼Œä¿®æ”¹çˆ¶è§’è‰²éœ€è¦ç‰¹åˆ¥å°å¿ƒ
        if ($this->isEditing && $this->role && $this->role->hasChildren()) {
            return false;
        }
        
        return true;
    }

    /**
     * æª¢æŸ¥æ˜¯å¦å¯ä»¥åœç”¨è§’è‰²
     */
    public function getCanDeactivateProperty(): bool
    {
        if (!$this->isEditing) {
            return true;
        }
        
        // ç³»çµ±è§’è‰²ä¸­çš„æ ¸å¿ƒè§’è‰²ä¸èƒ½åœç”¨
        $protectedRoles = ['super_admin', 'admin'];
        if ($this->isSystemRole && in_array($this->role->name, $protectedRoles)) {
            return false;
        }
        
        return true;
    }

    /**
     * å–å¾—çˆ¶è§’è‰²è³‡è¨Š
     */
    public function getParentRoleInfoProperty(): ?array
    {
        if (!$this->parent_id) {
            return null;
        }
        
        $parent = collect($this->availableParents)->firstWhere('id', $this->parent_id);
        return $parent;
    }

    /**
     * æ›´æ–°æ¬Šé™ç¹¼æ‰¿
     */
    private function updatePermissionInheritance(): void
    {
        if (!$this->role) {
            return;
        }
        
        // æ¸…é™¤è§’è‰²çš„æ¬Šé™å¿«å–
        cache()->forget("role_all_permissions_{$this->role->id}");
        
        // éžè¿´æ¸…é™¤æ‰€æœ‰å­è§’è‰²çš„æ¬Šé™å¿«å–
        $descendants = $this->role->getDescendants();
        foreach ($descendants as $descendant) {
            cache()->forget("role_all_permissions_{$descendant->id}");
        }
        
        $this->dispatch('permission-inheritance-updated', [
            'roleId' => $this->role->id,
            'affectedRoles' => $descendants->pluck('id')->toArray()
        ]);
    }

    /**
     * å–å¾—æ¬Šé™ç¹¼æ‰¿é è¦½è³‡è¨Š
     */
    public function getPermissionInheritancePreviewProperty(): ?array
    {
        if (!$this->parent_id) {
            return null;
        }
        
        try {
            $parentRole = Role::find($this->parent_id);
            if (!$parentRole) {
                return null;
            }
            
            $inheritedPermissions = $parentRole->getAllPermissions();
            $currentPermissions = $this->isEditing && $this->role ? 
                $this->role->getDirectPermissions() : collect();
            
            return [
                'parent_name' => $parentRole->display_name,
                'inherited_count' => $inheritedPermissions->count(),
                'current_count' => $currentPermissions->count(),
                'total_count' => $inheritedPermissions->merge($currentPermissions)->unique('id')->count(),
                'inherited_permissions' => $inheritedPermissions->groupBy('module')->map(function ($permissions) {
                    return $permissions->pluck('display_name')->toArray();
                })->toArray()
            ];
        } catch (\Exception $e) {
            return null;
        }
    }

    /**
     * æ¨™è¨˜è¡¨å–®æœ‰è®Šæ›´
     */
    private function markAsChanged(): void
    {
        $this->hasUnsavedChanges = true;
        
        if ($this->autoSaveEnabled && $this->isEditing) {
            $this->scheduleAutoSave();
        }
    }

    /**
     * æŽ’ç¨‹è‡ªå‹•å„²å­˜
     */
    private function scheduleAutoSave(): void
    {
        // ä½¿ç”¨ JavaScript è¨­å®šå»¶é²è‡ªå‹•å„²å­˜
        $this->dispatch('schedule-auto-save');
    }

    /**
     * åŸ·è¡Œè‡ªå‹•å„²å­˜
     */
    public function autoSave(): void
    {
        if (!$this->autoSaveEnabled || !$this->hasUnsavedChanges || !$this->isEditing) {
            return;
        }

        try {
            // åªé©—è­‰å¿…è¦æ¬„ä½é€²è¡Œè‡ªå‹•å„²å­˜
            $this->validateOnly(['display_name']);
            
            if ($this->errors->isEmpty()) {
                $data = [
                    'display_name' => $this->display_name,
                    'description' => $this->description,
                    'parent_id' => $this->parent_id,
                    'is_active' => $this->is_active,
                ];

                // åªæœ‰éžç³»çµ±è§’è‰²æ‰èƒ½ä¿®æ”¹åç¨±
                if (!$this->isSystemRole && !empty($this->name)) {
                    $data['name'] = $this->name;
                }

                $this->roleRepository->update($this->role, $data);
                
                $this->hasUnsavedChanges = false;
                $this->lastAutoSaveTime = now()->format('H:i:s');
                
                $this->dispatch('auto-save-completed', [
                    'message' => 'å·²è‡ªå‹•å„²å­˜',
                    'time' => $this->lastAutoSaveTime
                ]);
            }
        } catch (\Exception $e) {
            // è‡ªå‹•å„²å­˜å¤±æ•—æ™‚ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œé¿å…å¹²æ“¾ä½¿ç”¨è€…
            logger()->warning('Auto-save failed for role form', [
                'role_id' => $this->role?->id,
                'error' => $e->getMessage()
            ]);
        }
    }

    /**
     * åˆ‡æ›è‡ªå‹•å„²å­˜åŠŸèƒ½
     */
    public function toggleAutoSave(): void
    {
        $this->autoSaveEnabled = !$this->autoSaveEnabled;
        
        $message = $this->autoSaveEnabled ? 'å·²å•Ÿç”¨è‡ªå‹•å„²å­˜' : 'å·²åœç”¨è‡ªå‹•å„²å­˜';
        $this->dispatch('auto-save-toggled', ['message' => $message]);
    }

    /**
     * æª¢æŸ¥æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
     */
    public function getHasUnsavedChangesProperty(): bool
    {
        return $this->hasUnsavedChanges;
    }

    /**
     * å–å¾—è‡ªå‹•å„²å­˜ç‹€æ…‹æ–‡å­—
     */
    public function getAutoSaveStatusProperty(): string
    {
        if (!$this->autoSaveEnabled) {
            return 'è‡ªå‹•å„²å­˜å·²åœç”¨';
        }
        
        if ($this->hasUnsavedChanges) {
            return 'æœ‰æœªå„²å­˜çš„è®Šæ›´';
        }
        
        if ($this->lastAutoSaveTime) {
            return "æœ€å¾Œè‡ªå‹•å„²å­˜ï¼š{$this->lastAutoSaveTime}";
        }
        
        return 'è‡ªå‹•å„²å­˜å·²å•Ÿç”¨';
    }

    /**
     * ç›£è½æè¿°æ¬„ä½è®Šæ›´
     */
    public function updatedDescription(): void
    {
        $this->markAsChanged();
    }

    /**
     * ç›£è½å•Ÿç”¨ç‹€æ…‹è®Šæ›´
     */
    public function updatedIsActive(): void
    {
        $this->markAsChanged();
    }

    /**
     * ç›£è½è§’è‰²åˆ—è¡¨æ›´æ–°äº‹ä»¶
     */
    #[On('role-list-updated')]
    public function handleRoleListUpdated(): void
    {
        $this->loadAvailableParents();
    }

    /**
     * è™•ç†é©—è­‰å¤±æ•—
     */
    public function getErrorBag()
    {
        return parent::getErrorBag();
    }

    /**
     * å–å¾—è¡¨å–®é©—è­‰æ‘˜è¦
     */
    public function getValidationSummaryProperty(): array
    {
        $errors = $this->getErrorBag();
        if ($errors->isEmpty()) {
            return [];
        }

        return [
            'hasErrors' => true,
            'errorCount' => $errors->count(),
            'firstError' => $errors->first(),
            'errorFields' => $errors->keys()
        ];
    }

    /**
     * æª¢æŸ¥ç‰¹å®šæ¬„ä½æ˜¯å¦æœ‰éŒ¯èª¤
     */
    public function hasFieldError(string $field): bool
    {
        return $this->getErrorBag()->has($field);
    }

    /**
     * å–å¾—æ¬„ä½çš„ç¬¬ä¸€å€‹éŒ¯èª¤è¨Šæ¯
     */
    public function getFieldError(string $field): ?string
    {
        return $this->getErrorBag()->first($field);
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.roles.role-form');
    }
}