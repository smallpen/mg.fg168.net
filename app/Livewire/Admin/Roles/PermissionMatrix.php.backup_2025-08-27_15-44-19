<?php

namespace App\Livewire\Admin\Roles;

use App\Models\Role;
use App\Models\Permission;
use App\Repositories\Contracts\RoleRepositoryInterface;
use App\Repositories\Contracts\PermissionRepositoryInterface;
use Livewire\Component;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

/**
 * æ¬Šé™çŸ©é™£ç®¡ç†å…ƒä»¶
 * 
 * æä¾›è¦–è¦ºåŒ–çš„æ¬Šé™çŸ©é™£ä»‹é¢ï¼Œæ”¯æ´æŒ‰æ¨¡çµ„åˆ†çµ„é¡¯ç¤ºã€
 * æ¬Šé™å‹¾é¸/å–æ¶ˆã€ä¾è³´é—œä¿‚è‡ªå‹•è™•ç†å’Œæ‰¹é‡æ“ä½œåŠŸèƒ½
 */
class PermissionMatrix extends Component
{
    /**
     * æœå°‹é—œéµå­—
     */
    public string $search = '';

    /**
     * æ¨¡çµ„ç¯©é¸
     */
    public string $moduleFilter = '';

    /**
     * é¡¯ç¤ºæ¨¡å¼ï¼šmatrixï¼ˆçŸ©é™£ï¼‰æˆ– listï¼ˆåˆ—è¡¨ï¼‰
     */
    public string $viewMode = 'matrix';

    /**
     * æ˜¯å¦é¡¯ç¤ºæ¬Šé™æè¿°
     */
    public bool $showDescriptions = false;

    /**
     * æ˜¯å¦é¡¯ç¤ºè®Šæ›´é è¦½
     */
    public bool $showPreview = false;

    /**
     * æ¬Šé™è®Šæ›´è¨˜éŒ„
     */
    public array $permissionChanges = [];

    /**
     * é¸ä¸­çš„è§’è‰²ï¼ˆç”¨æ–¼æ‰¹é‡æ“ä½œï¼‰
     */
    public array $selectedRoles = [];

    /**
     * é¸ä¸­çš„æ¬Šé™ï¼ˆç”¨æ–¼æ‰¹é‡æ“ä½œï¼‰
     */
    public array $selectedPermissions = [];

    /**
     * æ‰¹é‡æ“ä½œæ¨¡å¼
     */
    public bool $bulkMode = false;

    /**
     * è³‡æ–™å­˜å–å±¤
     */
    protected ?RoleRepositoryInterface $roleRepository = null;
    protected ?PermissionRepositoryInterface $permissionRepository = null;

    /**
     * å…ƒä»¶åˆå§‹åŒ–
     */
    public function mount()
    {
        $this->initializeRepositories();
        
        // æª¢æŸ¥æ¬Šé™
        $this->authorize('roles.view');
    }

    /**
     * åˆå§‹åŒ–è³‡æ–™å­˜å–å±¤
     */
    protected function initializeRepositories(): void
    {
        if (!$this->roleRepository) {
            $this->roleRepository = app(RoleRepositoryInterface::class);
        }
        
        if (!$this->permissionRepository) {
            $this->permissionRepository = app(PermissionRepositoryInterface::class);
        }
    }

    /**
     * å–å¾—æ‰€æœ‰è§’è‰²ï¼ˆå«æ¬Šé™æ•¸é‡ï¼‰
     */
    public function getRolesProperty(): Collection
    {
        return Cache::remember('permission_matrix_roles', 300, function () {
            return Role::with('permissions')
                      ->withCount('permissions')
                      ->where('is_active', true)
                      ->orderBy('name')
                      ->get();
        });
    }

    /**
     * å–å¾—æ‰€æœ‰æ¨¡çµ„åˆ—è¡¨
     */
    public function getModulesProperty(): Collection
    {
        $this->initializeRepositories();
        
        return Cache::remember('permission_matrix_modules', 300, function () {
            return $this->permissionRepository->getAllModules();
        });
    }

    /**
     * å–å¾—ç¯©é¸å¾Œçš„æ¬Šé™ï¼ˆæŒ‰æ¨¡çµ„åˆ†çµ„ï¼‰
     */
    public function getFilteredPermissionsProperty(): Collection
    {
        $cacheKey = 'permission_matrix_filtered_' . md5($this->search . $this->moduleFilter);
        
        return Cache::remember($cacheKey, 300, function () {
            $query = Permission::query();

            // æœå°‹ç¯©é¸
            if ($this->search) {
                $query->where(function ($q) {
                    $q->where('name', 'like', "%{$this->search}%")
                      ->orWhere('display_name', 'like', "%{$this->search}%")
                      ->orWhere('description', 'like', "%{$this->search}%");
                });
            }

            // æ¨¡çµ„ç¯©é¸
            if ($this->moduleFilter) {
                $query->where('module', $this->moduleFilter);
            }

            return $query->orderBy('module')
                        ->orderBy('name')
                        ->get()
                        ->groupBy('module');
        });
    }

    /**
     * å–å¾—è®Šæ›´çµ±è¨ˆ
     */
    public function getChangeStatsProperty(): array
    {
        $add = collect($this->permissionChanges)->where('action', 'add')->count();
        $remove = collect($this->permissionChanges)->where('action', 'remove')->count();
        
        return [
            'total' => $add + $remove,
            'add' => $add,
            'remove' => $remove
        ];
    }

    /**
     * åˆ‡æ›æ¬Šé™ç‹€æ…‹
     */
    public function togglePermission(int $roleId, int $permissionId): void
    {
        $this->authorize('roles.edit');

        try {
            $role = Role::findOrFail($roleId);
            $permission = Permission::findOrFail($permissionId);
            
            $hasPermission = $this->roleHasPermission($roleId, $permissionId);
            $changeKey = "{$roleId}_{$permissionId}";

            if ($hasPermission) {
                // ç§»é™¤æ¬Šé™
                $this->addPermissionChange($changeKey, [
                    'role_id' => $roleId,
                    'permission_id' => $permissionId,
                    'role_name' => $role->display_name,
                    'permission_name' => $permission->display_name,
                    'action' => 'remove'
                ]);
            } else {
                // æ–°å¢žæ¬Šé™
                $this->addPermissionChange($changeKey, [
                    'role_id' => $roleId,
                    'permission_id' => $permissionId,
                    'role_name' => $role->display_name,
                    'permission_name' => $permission->display_name,
                    'action' => 'add'
                ]);

                // æª¢æŸ¥ä¸¦è‡ªå‹•æ–°å¢žä¾è³´æ¬Šé™
                $this->handlePermissionDependencies($roleId, $permission);
            }

            $this->updatePreviewStatus();
            $this->dispatch('permission-toggled', roleId: $roleId, permissionId: $permissionId);

        } catch (\Exception $e) {
            Log::error('æ¬Šé™åˆ‡æ›å¤±æ•—', [
                'role_id' => $roleId,
                'permission_id' => $permissionId,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¬Šé™åˆ‡æ›å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * è™•ç†æ¬Šé™ä¾è³´é—œä¿‚
     */
    protected function handlePermissionDependencies(int $roleId, Permission $permission): void
    {
        $dependencies = $permission->dependencies;
        
        foreach ($dependencies as $dependency) {
            if (!$this->roleHasPermission($roleId, $dependency->id)) {
                $changeKey = "{$roleId}_{$dependency->id}";
                $this->addPermissionChange($changeKey, [
                    'role_id' => $roleId,
                    'permission_id' => $dependency->id,
                    'role_name' => Role::find($roleId)->display_name,
                    'permission_name' => $dependency->display_name,
                    'action' => 'add',
                    'auto_added' => true
                ]);
            }
        }
    }

    /**
     * æ–°å¢žæ¬Šé™è®Šæ›´è¨˜éŒ„
     */
    protected function addPermissionChange(string $key, array $change): void
    {
        // å¦‚æžœå·²å­˜åœ¨ç›¸åçš„æ“ä½œï¼Œå‰‡ç§»é™¤
        if (isset($this->permissionChanges[$key])) {
            unset($this->permissionChanges[$key]);
        } else {
            $this->permissionChanges[$key] = $change;
        }
    }

    /**
     * æ‰¹é‡æŒ‡æ´¾æ¨¡çµ„æ¬Šé™çµ¦è§’è‰²
     */
    public function assignModuleToRole(int $roleId, string $module): void
    {
        $this->authorize('roles.edit');

        try {
            $role = Role::findOrFail($roleId);
            $permissions = Permission::where('module', $module)->get();

            foreach ($permissions as $permission) {
                if (!$this->roleHasPermission($roleId, $permission->id)) {
                    $changeKey = "{$roleId}_{$permission->id}";
                    $this->addPermissionChange($changeKey, [
                        'role_id' => $roleId,
                        'permission_id' => $permission->id,
                        'role_name' => $role->display_name,
                        'permission_name' => $permission->display_name,
                        'action' => 'add'
                    ]);
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('module-assigned', roleId: $roleId, module: $module);

        } catch (\Exception $e) {
            Log::error('æ¨¡çµ„æ¬Šé™æŒ‡æ´¾å¤±æ•—', [
                'role_id' => $roleId,
                'module' => $module,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¨¡çµ„æ¬Šé™æŒ‡æ´¾å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * æ‰¹é‡ç§»é™¤è§’è‰²çš„æ¨¡çµ„æ¬Šé™
     */
    public function revokeModuleFromRole(int $roleId, string $module): void
    {
        $this->authorize('roles.edit');

        try {
            $role = Role::findOrFail($roleId);
            $permissions = Permission::where('module', $module)->get();

            foreach ($permissions as $permission) {
                if ($this->roleHasPermission($roleId, $permission->id)) {
                    $changeKey = "{$roleId}_{$permission->id}";
                    $this->addPermissionChange($changeKey, [
                        'role_id' => $roleId,
                        'permission_id' => $permission->id,
                        'role_name' => $role->display_name,
                        'permission_name' => $permission->display_name,
                        'action' => 'remove'
                    ]);
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('module-revoked', roleId: $roleId, module: $module);

        } catch (\Exception $e) {
            Log::error('æ¨¡çµ„æ¬Šé™ç§»é™¤å¤±æ•—', [
                'role_id' => $roleId,
                'module' => $module,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¨¡çµ„æ¬Šé™ç§»é™¤å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * æŒ‡æ´¾æ¬Šé™çµ¦æ‰€æœ‰è§’è‰²
     */
    public function assignPermissionToAllRoles(int $permissionId): void
    {
        $this->authorize('roles.edit');

        try {
            $permission = Permission::findOrFail($permissionId);
            
            foreach ($this->roles as $role) {
                if (!$this->roleHasPermission($role->id, $permissionId)) {
                    $changeKey = "{$role->id}_{$permissionId}";
                    $this->addPermissionChange($changeKey, [
                        'role_id' => $role->id,
                        'permission_id' => $permissionId,
                        'role_name' => $role->display_name,
                        'permission_name' => $permission->display_name,
                        'action' => 'add'
                    ]);
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('permission-assigned-to-all', permissionId: $permissionId);

        } catch (\Exception $e) {
            Log::error('æ¬Šé™æ‰¹é‡æŒ‡æ´¾å¤±æ•—', [
                'permission_id' => $permissionId,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¬Šé™æ‰¹é‡æŒ‡æ´¾å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * å¾žæ‰€æœ‰è§’è‰²ç§»é™¤æ¬Šé™
     */
    public function revokePermissionFromAllRoles(int $permissionId): void
    {
        $this->authorize('roles.edit');

        try {
            $permission = Permission::findOrFail($permissionId);
            
            foreach ($this->roles as $role) {
                if ($this->roleHasPermission($role->id, $permissionId)) {
                    $changeKey = "{$role->id}_{$permissionId}";
                    $this->addPermissionChange($changeKey, [
                        'role_id' => $role->id,
                        'permission_id' => $permissionId,
                        'role_name' => $role->display_name,
                        'permission_name' => $permission->display_name,
                        'action' => 'remove'
                    ]);
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('permission-revoked-from-all', permissionId: $permissionId);

        } catch (\Exception $e) {
            Log::error('æ¬Šé™æ‰¹é‡ç§»é™¤å¤±æ•—', [
                'permission_id' => $permissionId,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¬Šé™æ‰¹é‡ç§»é™¤å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * æŒ‡æ´¾æ¨¡çµ„æ¬Šé™çµ¦æ‰€æœ‰è§’è‰²
     */
    public function assignModuleToAllRoles(string $module): void
    {
        $this->authorize('roles.edit');

        try {
            $permissions = Permission::where('module', $module)->get();
            
            foreach ($this->roles as $role) {
                foreach ($permissions as $permission) {
                    if (!$this->roleHasPermission($role->id, $permission->id)) {
                        $changeKey = "{$role->id}_{$permission->id}";
                        $this->addPermissionChange($changeKey, [
                            'role_id' => $role->id,
                            'permission_id' => $permission->id,
                            'role_name' => $role->display_name,
                            'permission_name' => $permission->display_name,
                            'action' => 'add'
                        ]);
                    }
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('module-assigned-to-all', module: $module);

        } catch (\Exception $e) {
            Log::error('æ¨¡çµ„æ¬Šé™æ‰¹é‡æŒ‡æ´¾å¤±æ•—', [
                'module' => $module,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¨¡çµ„æ¬Šé™æ‰¹é‡æŒ‡æ´¾å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * å¾žæ‰€æœ‰è§’è‰²ç§»é™¤æ¨¡çµ„æ¬Šé™
     */
    public function revokeModuleFromAllRoles(string $module): void
    {
        $this->authorize('roles.edit');

        try {
            $permissions = Permission::where('module', $module)->get();
            
            foreach ($this->roles as $role) {
                foreach ($permissions as $permission) {
                    if ($this->roleHasPermission($role->id, $permission->id)) {
                        $changeKey = "{$role->id}_{$permission->id}";
                        $this->addPermissionChange($changeKey, [
                            'role_id' => $role->id,
                            'permission_id' => $permission->id,
                            'role_name' => $role->display_name,
                            'permission_name' => $permission->display_name,
                            'action' => 'remove'
                        ]);
                    }
                }
            }

            $this->updatePreviewStatus();
            $this->dispatch('module-revoked-from-all', module: $module);

        } catch (\Exception $e) {
            Log::error('æ¨¡çµ„æ¬Šé™æ‰¹é‡ç§»é™¤å¤±æ•—', [
                'module' => $module,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¨¡çµ„æ¬Šé™æ‰¹é‡ç§»é™¤å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * æ‡‰ç”¨æ‰€æœ‰æ¬Šé™è®Šæ›´
     */
    public function applyChanges(): void
    {
        $this->authorize('roles.edit');

        if (empty($this->permissionChanges)) {
            $this->dispatch('warning', message: 'æ²’æœ‰å¾…æ‡‰ç”¨çš„è®Šæ›´');
            return;
        }

        try {
            DB::beginTransaction();

            foreach ($this->permissionChanges as $change) {
                $role = Role::findOrFail($change['role_id']);
                $permission = Permission::findOrFail($change['permission_id']);

                if ($change['action'] === 'add') {
                    $role->givePermissionTo($permission);
                } else {
                    $role->revokePermissionTo($permission);
                }
            }

            DB::commit();

            // æ¸…é™¤å¿«å–
            $this->clearPermissionCache();

            // é‡ç½®è®Šæ›´è¨˜éŒ„
            $this->permissionChanges = [];
            $this->showPreview = false;

            $this->dispatch('success', message: 'æ¬Šé™è®Šæ›´å·²æˆåŠŸæ‡‰ç”¨');
            $this->dispatch('permissions-applied');

        } catch (\Exception $e) {
            DB::rollBack();
            
            Log::error('æ¬Šé™è®Šæ›´æ‡‰ç”¨å¤±æ•—', [
                'changes' => $this->permissionChanges,
                'error' => $e->getMessage()
            ]);
            
            $this->dispatch('error', message: 'æ¬Šé™è®Šæ›´æ‡‰ç”¨å¤±æ•—ï¼š' . $e->getMessage());
        }
    }

    /**
     * å–æ¶ˆæ‰€æœ‰æ¬Šé™è®Šæ›´
     */
    public function cancelChanges(): void
    {
        $this->permissionChanges = [];
        $this->showPreview = false;
        
        $this->dispatch('info', message: 'å·²å–æ¶ˆæ‰€æœ‰æ¬Šé™è®Šæ›´');
        $this->dispatch('changes-cancelled');
    }

    /**
     * ç§»é™¤ç‰¹å®šè®Šæ›´
     */
    public function removeChange(string $changeKey): void
    {
        if (isset($this->permissionChanges[$changeKey])) {
            unset($this->permissionChanges[$changeKey]);
            $this->updatePreviewStatus();
            
            $this->dispatch('change-removed', changeKey: $changeKey);
        }
    }

    /**
     * åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
     */
    public function toggleViewMode(): void
    {
        $this->viewMode = $this->viewMode === 'matrix' ? 'list' : 'matrix';
    }

    /**
     * åˆ‡æ›æè¿°é¡¯ç¤º
     */
    public function toggleDescriptions(): void
    {
        $this->showDescriptions = !$this->showDescriptions;
    }

    /**
     * æ¸…é™¤ç¯©é¸æ¢ä»¶
     */
    public function clearFilters(): void
    {
        try {
        // è¨˜éŒ„é‡ç½®æ“ä½œ
        \Log::info('ðŸ”„ clearFilters - æ–¹æ³•è¢«å‘¼å«', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
        ]);
        
        // é‡ç½®å±¬æ€§
        $this->search = '';
        $this->moduleFilter = '';
        $this->viewMode = '';
        $this->showDescriptions = false;
        $this->showPreview = false;
        $this->permissionChanges = false;
        $this->selectedRoles = [];
        $this->selectedPermissions = [];
        $this->bulkMode = '';
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('clearFilters-completed');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… clearFilters - é‡ç½®å®Œæˆ');

        
        $this->resetValidation();
    } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'clearFilters',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * æª¢æŸ¥è§’è‰²æ˜¯å¦æ“æœ‰ç‰¹å®šæ¬Šé™
     */
    public function roleHasPermission(int $roleId, int $permissionId): bool
    {
        $role = $this->roles->firstWhere('id', $roleId);
        if (!$role) {
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰å¾…è™•ç†çš„è®Šæ›´
        $changeKey = "{$roleId}_{$permissionId}";
        if (isset($this->permissionChanges[$changeKey])) {
            $change = $this->permissionChanges[$changeKey];
            $currentHas = $role->permissions->contains('id', $permissionId);
            
            return $change['action'] === 'add' ? true : false;
        }

        return $role->permissions->contains('id', $permissionId);
    }

    /**
     * æª¢æŸ¥è§’è‰²æ˜¯å¦æ“æœ‰æ¨¡çµ„çš„æ‰€æœ‰æ¬Šé™
     */
    public function roleHasAllModulePermissions(int $roleId, string $module): bool
    {
        $modulePermissions = Permission::where('module', $module)->get();
        
        foreach ($modulePermissions as $permission) {
            if (!$this->roleHasPermission($roleId, $permission->id)) {
                return false;
            }
        }
        
        return true;
    }

    /**
     * æª¢æŸ¥è§’è‰²æ˜¯å¦æ“æœ‰æ¨¡çµ„çš„éƒ¨åˆ†æ¬Šé™
     */
    public function roleHasSomeModulePermissions(int $roleId, string $module): bool
    {
        $modulePermissions = Permission::where('module', $module)->get();
        
        foreach ($modulePermissions as $permission) {
            if ($this->roleHasPermission($roleId, $permission->id)) {
                return true;
            }
        }
        
        return false;
    }

    /**
     * å–å¾—æ¬Šé™è®Šæ›´ç‹€æ…‹
     */
    public function getPermissionChangeStatus(int $roleId, int $permissionId): ?string
    {
        $changeKey = "{$roleId}_{$permissionId}";
        
        if (isset($this->permissionChanges[$changeKey])) {
            return $this->permissionChanges[$changeKey]['action'];
        }
        
        return null;
    }

    /**
     * æ›´æ–°é è¦½ç‹€æ…‹
     */
    protected function updatePreviewStatus(): void
    {
        $this->showPreview = !empty($this->permissionChanges);
    }

    /**
     * æ¸…é™¤æ¬Šé™ç›¸é—œå¿«å–
     */
    protected function clearPermissionCache(): void
    {
        Cache::forget('permission_matrix_roles');
        Cache::forget('permission_matrix_modules');
        
        // æ¸…é™¤ç¯©é¸å¿«å–
        $cachePattern = 'permission_matrix_filtered_*';
        // æ³¨æ„ï¼šé€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›å¿«å–é©…å‹•å¯¦ä½œæ¸…é™¤æ¨¡å¼åŒ¹é…çš„å¿«å–
    }

    /**
     * ç›£è½æœå°‹è®Šæ›´
     */
    public function updatedSearch(): void
    {
        $this->dispatch('search-updated', search: $this->search);
    }

    /**
     * ç›£è½æ¨¡çµ„ç¯©é¸è®Šæ›´
     */
    public function updatedModuleFilter(): void
    {
        $this->dispatch('module-filter-updated', module: $this->moduleFilter);
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.roles.permission-matrix');
    }
}