<?php

namespace App\Livewire\Admin\Layout;

use App\Services\KeyboardShortcutService;
use Livewire\Component;
use Livewire\Attributes\On;
use Livewire\Attributes\Validate;

/**
 * å¿«æ·éµè¨­å®šå…ƒä»¶
 * å…è¨±ä½¿ç”¨è€…è‡ªè¨‚å¿«æ·éµé…ç½®
 */
class ShortcutSettings extends Component
{
    /**
     * å¿«æ·éµæœå‹™
     */
    protected KeyboardShortcutService $shortcutService;

    /**
     * å°è©±æ¡†æ˜¯å¦é–‹å•Ÿ
     */
    public bool $isOpen = false;

    /**
     * ç•¶å‰ç·¨è¼¯çš„å¿«æ·éµ
     */
    public ?string $editingKey = null;

    /**
     * è¡¨å–®è³‡æ–™
     */
    #[Validate('required|string|max:100')]
    public string $shortcutKey = '';

    #[Validate('required|string|max:255')]
    public string $description = '';

    #[Validate('required|string')]
    public string $action = '';

    #[Validate('nullable|string|max:255')]
    public string $target = '';

    #[Validate('required|string')]
    public string $category = 'custom';

    public bool $enabled = true;

    /**
     * å¯ç”¨çš„å‹•ä½œé¡žåž‹
     */
    protected array $availableActions = [
        'navigate' => 'å°Žèˆªåˆ°é é¢',
        'toggle-search' => 'åˆ‡æ›æœå°‹',
        'toggle-notifications' => 'åˆ‡æ›é€šçŸ¥',
        'toggle-theme' => 'åˆ‡æ›ä¸»é¡Œ',
        'toggle-sidebar' => 'åˆ‡æ›å´é‚Šé¸å–®',
        'show-help' => 'é¡¯ç¤ºèªªæ˜Ž',
        'close-modal' => 'é—œé–‰å°è©±æ¡†',
        'custom' => 'è‡ªè¨‚å‹•ä½œ',
    ];

    /**
     * è¡çªæª¢æ¸¬çµæžœ
     */
    public array $conflicts = [];

    /**
     * åˆå§‹åŒ–å…ƒä»¶
     */
    public function boot(KeyboardShortcutService $shortcutService): void
    {
        $this->shortcutService = $shortcutService;
    }

    /**
     * é–‹å•Ÿè¨­å®šå°è©±æ¡†
     */
    public function open(): void
    {
        $this->isOpen = true;
        $this->resetForm();
    }

    /**
     * é—œé–‰è¨­å®šå°è©±æ¡†
     */
    public function close(): void
    {
        $this->isOpen = false;
        $this->resetForm();
    }

    /**
     * é‡ç½®è¡¨å–®
     */
    public function resetForm(): void
    {
        try {
        // è¨˜éŒ„é‡ç½®æ“ä½œ
        \Log::info('ðŸ”„ resetForm - æ–¹æ³•è¢«å‘¼å«', [
            'timestamp' => now()->toISOString(),
            'user' => auth()->user()->username ?? 'unknown',
        ]);
        
        // é‡ç½®å±¬æ€§
        $this->isOpen = false;
        $this->editingKey = '';
        $this->shortcutKey = '';
        $this->description = '';
        $this->action = '';
        $this->target = '';
        $this->category = '';
        $this->enabled = '';
        $this->conflicts = '';
        $this->resetValidation();
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“å…ƒä»¶ä»¥ç¢ºä¿å‰ç«¯åŒæ­¥
        $this->dispatch('$refresh');
        
        // ç™¼é€å‰ç«¯åˆ·æ–°äº‹ä»¶
        $this->dispatch('resetForm-completed');
        
        // è¨˜éŒ„é‡ç½®å®Œæˆ
        \Log::info('âœ… resetForm - é‡ç½®å®Œæˆ');

        } catch (\Exception $e) {
            \Log::error('é‡ç½®æ–¹æ³•åŸ·è¡Œå¤±æ•—', [
                'method' => 'resetForm',
                'error' => $e->getMessage(),
                'component' => static::class,
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦'
            ]);
        }}

    /**
     * ç·¨è¼¯å¿«æ·éµ
     */
    public function editShortcut(string $key): void
    {
        $shortcuts = $this->shortcutService->getUserShortcuts();
        
        if (!$shortcuts->has($key)) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'æ‰¾ä¸åˆ°æŒ‡å®šçš„å¿«æ·éµ',
            ]);
            return;
        }

        $shortcut = $shortcuts->get($key);
        
        $this->editingKey = $key;
        $this->shortcutKey = $key;
        $this->description = $shortcut['description'] ?? '';
        $this->action = $shortcut['action'] ?? '';
        $this->target = $shortcut['target'] ?? '';
        $this->category = $shortcut['category'] ?? 'custom';
        $this->enabled = $shortcut['enabled'] ?? true;
        
        $this->open();
    }

    /**
     * å»ºç«‹æ–°å¿«æ·éµ
     */
    public function createShortcut(): void
    {
        $this->resetForm();
        $this->open();
    }

    /**
     * å„²å­˜å¿«æ·éµ
     */
    public function save(): void
    {
        $this->validate();

        // æª¢æŸ¥å¿«æ·éµæ ¼å¼
        if (!$this->shortcutService->isValidShortcutKey($this->shortcutKey)) {
            $this->addError('shortcutKey', 'å¿«æ·éµæ ¼å¼ä¸æ­£ç¢º');
            return;
        }

        // æª¢æŸ¥è¡çªï¼ˆé™¤äº†æ­£åœ¨ç·¨è¼¯çš„å¿«æ·éµï¼‰
        if ($this->editingKey !== $this->shortcutKey && 
            $this->shortcutService->hasConflict($this->shortcutKey)) {
            $this->addError('shortcutKey', 'æ­¤å¿«æ·éµå·²è¢«ä½¿ç”¨');
            return;
        }

        $config = [
            'description' => $this->description,
            'action' => $this->action,
            'target' => $this->target,
            'category' => $this->category,
            'enabled' => $this->enabled,
        ];

        try {
            if ($this->editingKey) {
                // æ›´æ–°ç¾æœ‰å¿«æ·éµ
                if ($this->editingKey !== $this->shortcutKey) {
                    // å¿«æ·éµæ”¹è®Šäº†ï¼Œéœ€è¦åˆªé™¤èˆŠçš„ä¸¦å»ºç«‹æ–°çš„
                    $this->shortcutService->removeShortcut($this->editingKey);
                    $this->shortcutService->registerShortcut($this->shortcutKey, $config);
                } else {
                    // åªæ›´æ–°é…ç½®
                    $this->shortcutService->updateShortcut($this->shortcutKey, $config);
                }
            } else {
                // å»ºç«‹æ–°å¿«æ·éµ
                $this->shortcutService->registerShortcut($this->shortcutKey, $config);
            }

            $this->dispatch('shortcuts-updated');
            $this->dispatch('show-toast', [
                'type' => 'success',
                'message' => 'å¿«æ·éµå·²å„²å­˜',
            ]);
            
            $this->close();
        } catch (\Exception $e) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'å„²å­˜å¤±æ•—ï¼š' . $e->getMessage(),
            ]);
        }
    }

    /**
     * åˆªé™¤å¿«æ·éµ
     */
    public function deleteShortcut(string $key): void
    {
        try {
            $this->shortcutService->removeShortcut($key);
            
            $this->dispatch('shortcuts-updated');
            $this->dispatch('show-toast', [
                'type' => 'success',
                'message' => 'å¿«æ·éµå·²åˆªé™¤',
            ]);
        } catch (\Exception $e) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'åˆªé™¤å¤±æ•—ï¼š' . $e->getMessage(),
            ]);
        }
    }

    /**
     * é‡ç½®ç‚ºé è¨­è¨­å®š
     */
    public function resetToDefaults(): void
    {
        try {
            $this->shortcutService->resetToDefaults();
            
            $this->dispatch('shortcuts-updated');
            $this->dispatch('show-toast', [
                'type' => 'success',
                'message' => 'å·²é‡ç½®ç‚ºé è¨­å¿«æ·éµè¨­å®š',
            ]);
        } catch (\Exception $e) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'é‡ç½®å¤±æ•—ï¼š' . $e->getMessage(),
            ]);
        }
    }

    /**
     * åŒ¯å‡ºå¿«æ·éµè¨­å®š
     */
    public function exportSettings(): void
    {
        try {
            $shortcuts = $this->shortcutService->exportShortcuts();
            
            $this->dispatch('download-file', [
                'filename' => 'keyboard-shortcuts-' . date('Y-m-d') . '.json',
                'content' => json_encode($shortcuts, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE),
                'type' => 'application/json',
            ]);
            
            $this->dispatch('show-toast', [
                'type' => 'success',
                'message' => 'å¿«æ·éµè¨­å®šå·²åŒ¯å‡º',
            ]);
        } catch (\Exception $e) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'åŒ¯å‡ºå¤±æ•—ï¼š' . $e->getMessage(),
            ]);
        }
    }

    /**
     * åŒ¯å…¥å¿«æ·éµè¨­å®š
     */
    public function importSettings(array $shortcuts, bool $overwrite = false): void
    {
        try {
            $results = $this->shortcutService->importShortcuts($shortcuts, $overwrite);
            
            $this->dispatch('shortcuts-updated');
            $this->dispatch('show-toast', [
                'type' => 'success',
                'message' => "å·²åŒ¯å…¥ {$results['imported']} å€‹å¿«æ·éµï¼Œè·³éŽ {$results['skipped']} å€‹",
            ]);
            
            if (!empty($results['conflicts'])) {
                $this->conflicts = $results['conflicts'];
            }
        } catch (\Exception $e) {
            $this->dispatch('show-toast', [
                'type' => 'error',
                'message' => 'åŒ¯å…¥å¤±æ•—ï¼š' . $e->getMessage(),
            ]);
        }
    }

    /**
     * æª¢æ¸¬å¿«æ·éµè¡çª
     */
    public function checkConflicts(): void
    {
        if (empty($this->shortcutKey)) {
            return;
        }

        if ($this->editingKey !== $this->shortcutKey && 
            $this->shortcutService->hasConflict($this->shortcutKey)) {
            $this->addError('shortcutKey', 'æ­¤å¿«æ·éµå·²è¢«ä½¿ç”¨');
        } else {
            $this->resetErrorBag('shortcutKey');
        }
    }

    /**
     * æ›´æ–°å¿«æ·éµè¼¸å…¥æ™‚æª¢æŸ¥è¡çª
     */
    public function updatedShortcutKey(): void
    {
        $this->checkConflicts();
    }

    /**
     * ç²å–æ‰€æœ‰å¿«æ·éµ
     */
    public function getShortcutsProperty(): array
    {
        return $this->shortcutService->getUserShortcuts()->toArray();
    }

    /**
     * ç²å–åˆ†é¡žåˆ—è¡¨
     */
    public function getCategoriesProperty(): array
    {
        return $this->shortcutService->getCategories();
    }

    /**
     * ç²å–å¯ç”¨å‹•ä½œ
     */
    public function getAvailableActionsProperty(): array
    {
        return $this->availableActions;
    }

    /**
     * ç›£è½é–‹å•Ÿè¨­å®šäº‹ä»¶
     */
    #[On('open-shortcut-settings')]
    public function handleOpenSettings(): void
    {
        $this->open();
    }

    /**
     * ç›£è½é—œé–‰å°è©±æ¡†äº‹ä»¶
     */
    #[On('close-modal')]
    public function handleCloseModal(): void
    {
        if ($this->isOpen) {
            $this->close();
        }
    }

    /**
     * æ¸²æŸ“å…ƒä»¶
     */
    public function render()
    {
        return view('livewire.admin.layout.shortcut-settings');
    }
}