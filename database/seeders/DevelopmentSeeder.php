<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;
use App\Models\User;
use App\Models\Role;
use App\Models\Permission;

/**
 * ÈñãÁôºÁí∞Â¢ÉÂ∞àÁî®Á®ÆÂ≠êÊ™îÊ°à
 * 
 * Âª∫Á´ãË±êÂØåÁöÑÊ∏¨Ë©¶Ë≥áÊñôÔºåÊñπ‰æøÈñãÁôºÂíåÊ∏¨Ë©¶‰ΩøÁî®ËÄÖÁÆ°ÁêÜÂäüËÉΩ
 */
class DevelopmentSeeder extends Seeder
{
    /**
     * Âü∑Ë°åÈñãÁôºÁí∞Â¢ÉÁ®ÆÂ≠ê
     */
    public function run(): void
    {
        $this->command->info('ÈñãÂßãÂª∫Á´ãÈñãÁôºÊ∏¨Ë©¶Ë≥áÊñô...');
        
        // Á¢∫‰øùÂü∫Êú¨ËßíËâ≤ÂíåÊ¨äÈôêÂ≠òÂú®
        $this->ensureBasicRolesAndPermissions();
        
        // Âª∫Á´ãÊ∏¨Ë©¶‰ΩøÁî®ËÄÖ
        $this->createTestUsers();
        
        $this->command->info('');
        $this->command->info('=== ÈñãÁôºÊ∏¨Ë©¶Ë≥áÊñôÂª∫Á´ãÂÆåÊàê ===');
        $this->displayAccountInfo();
    }

    /**
     * Á¢∫‰øùÂü∫Êú¨ËßíËâ≤ÂíåÊ¨äÈôêÂ≠òÂú®
     */
    private function ensureBasicRolesAndPermissions(): void
    {
        // Â¶ÇÊûúÊ≤íÊúâÂü∫Êú¨Ë≥áÊñôÔºåÂÖàÂü∑Ë°åÂü∫Êú¨ seeder
        if (Role::count() === 0 || Permission::count() === 0) {
            $this->command->info('Ê™¢Ê∏¨Âà∞Áº∫Â∞ëÂü∫Êú¨Ë≥áÊñôÔºåÊ≠£Âú®Âª∫Á´ã...');
            $this->call([
                PermissionSeeder::class,
                RoleSeeder::class,
            ]);
        }
    }

    /**
     * Âª∫Á´ãÊ∏¨Ë©¶‰ΩøÁî®ËÄÖ
     */
    private function createTestUsers(): void
    {
        // Âü∫Êú¨ÁÆ°ÁêÜÂì°Â∏≥Ëôü
        $basicUsers = [
            [
                'username' => 'superadmin',
                'name' => 'Ë∂ÖÁ¥öÁÆ°ÁêÜÂì°',
                'email' => 'superadmin@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['super_admin']
            ],
            [
                'username' => 'admin',
                'name' => 'Á≥ªÁµ±ÁÆ°ÁêÜÂì°',
                'email' => 'admin@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['admin']
            ],
        ];

        // Ê∏¨Ë©¶‰ΩøÁî®ËÄÖË≥áÊñô
        $testUsers = [
            // ‰∏çÂêåÁãÄÊÖãÁöÑ‰ΩøÁî®ËÄÖ
            [
                'username' => 'active_user',
                'name' => 'ÂïüÁî®‰ΩøÁî®ËÄÖ',
                'email' => 'active@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['user']
            ],
            [
                'username' => 'inactive_user',
                'name' => 'ÂÅúÁî®‰ΩøÁî®ËÄÖ',
                'email' => 'inactive@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'dark',
                'locale' => 'en',
                'is_active' => false,
                'roles' => ['user']
            ],
            
            // ‰∏çÂêåËßíËâ≤ÁöÑ‰ΩøÁî®ËÄÖ
            [
                'username' => 'manager',
                'name' => 'ÈÉ®ÈñÄÁ∂ìÁêÜ',
                'email' => 'manager@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['admin']
            ],
            [
                'username' => 'editor',
                'name' => 'ÂÖßÂÆπÁ∑®ËºØ',
                'email' => 'editor@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'dark',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['user']
            ],
            
            // Â§öËßíËâ≤‰ΩøÁî®ËÄÖ
            [
                'username' => 'multi_role',
                'name' => 'Â§öÈáçËßíËâ≤‰ΩøÁî®ËÄÖ',
                'email' => 'multi@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['admin', 'user']
            ],
            
            // ÁÑ°ËßíËâ≤‰ΩøÁî®ËÄÖ
            [
                'username' => 'no_role',
                'name' => 'ÁÑ°ËßíËâ≤‰ΩøÁî®ËÄÖ',
                'email' => 'norole@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'en',
                'is_active' => true,
                'roles' => []
            ],
            
            // Ê∏¨Ë©¶ÊêúÂ∞ãÂäüËÉΩÁöÑ‰ΩøÁî®ËÄÖ
            [
                'username' => 'john_doe',
                'name' => 'John Doe',
                'email' => 'john.doe@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'en',
                'is_active' => true,
                'roles' => ['user']
            ],
            [
                'username' => 'jane_smith',
                'name' => 'Jane Smith',
                'email' => 'jane.smith@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'dark',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['user']
            ],
            [
                'username' => 'bob_wilson',
                'name' => 'Bob Wilson',
                'email' => 'bob.wilson@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'en',
                'is_active' => false,
                'roles' => ['admin']
            ],
            
            // ‰∏≠ÊñáÂêçÁ®±‰ΩøÁî®ËÄÖ
            [
                'username' => 'wang_ming',
                'name' => 'ÁéãÂ∞èÊòé',
                'email' => 'wang.ming@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['user']
            ],
            [
                'username' => 'li_hua',
                'name' => 'ÊùéÂ∞èËèØ',
                'email' => 'li.hua@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'dark',
                'locale' => 'zh_TW',
                'is_active' => true,
                'roles' => ['admin']
            ],
            [
                'username' => 'chen_wei',
                'name' => 'Èô≥Â∞èÂÅâ',
                'email' => 'chen.wei@example.com',
                'password' => Hash::make('password123'),
                'theme_preference' => 'light',
                'locale' => 'zh_TW',
                'is_active' => false,
                'roles' => ['user']
            ],
        ];

        // Âêà‰ΩµÊâÄÊúâ‰ΩøÁî®ËÄÖË≥áÊñô
        $allUsers = array_merge($basicUsers, $testUsers);

        // Âª∫Á´ã‰ΩøÁî®ËÄÖ
        foreach ($allUsers as $userData) {
            $roles = $userData['roles'];
            unset($userData['roles']);

            // Âª∫Á´ãÊàñÊõ¥Êñ∞‰ΩøÁî®ËÄÖ
            $user = User::updateOrCreate(
                ['username' => $userData['username']],
                $userData
            );

            // Ê∏ÖÈô§ÁèæÊúâËßíËâ≤‰∏¶ÈáçÊñ∞ÊåáÊ¥æ
            $user->roles()->detach();
            
            // ÊåáÊ¥æËßíËâ≤
            foreach ($roles as $roleName) {
                $role = Role::where('name', $roleName)->first();
                if ($role) {
                    $user->assignRole($role);
                }
            }

            $this->command->info("‚úì ‰ΩøÁî®ËÄÖ: {$user->username} ({$user->name})");
        }

        $this->command->info("Â∑≤Âª∫Á´ã " . count($allUsers) . " ÂÄã‰ΩøÁî®ËÄÖ");
    }

    /**
     * È°ØÁ§∫Â∏≥ËôüË≥áË®ä
     */
    private function displayAccountInfo(): void
    {
        $this->command->info('');
        $this->command->info('=== Ê∏¨Ë©¶Â∏≥ËôüË≥áË®ä ===');
        $this->command->info('');
        
        $this->command->info('üîë ÁÆ°ÁêÜÂì°Â∏≥Ëôü:');
        $this->command->info('  Ë∂ÖÁ¥öÁÆ°ÁêÜÂì°: superadmin / password123');
        $this->command->info('  Á≥ªÁµ±ÁÆ°ÁêÜÂì°: admin / password123');
        $this->command->info('  ÈÉ®ÈñÄÁ∂ìÁêÜ: manager / password123');
        $this->command->info('');
        
        $this->command->info('üë§ ‰∏ÄËà¨‰ΩøÁî®ËÄÖ:');
        $this->command->info('  ÂïüÁî®‰ΩøÁî®ËÄÖ: active_user / password123');
        $this->command->info('  ÂÅúÁî®‰ΩøÁî®ËÄÖ: inactive_user / password123 (Â∑≤ÂÅúÁî®)');
        $this->command->info('  ÂÖßÂÆπÁ∑®ËºØ: editor / password123');
        $this->command->info('');
        
        $this->command->info('üåê Â§öË™ûË®ÄÊ∏¨Ë©¶:');
        $this->command->info('  John Doe: john_doe / password123 (Ëã±Êñá)');
        $this->command->info('  ÁéãÂ∞èÊòé: wang_ming / password123 (‰∏≠Êñá)');
        $this->command->info('  ÊùéÂ∞èËèØ: li_hua / password123 (‰∏≠Êñá)');
        $this->command->info('');
        
        $this->command->info('üîç ÊêúÂ∞ãÊ∏¨Ë©¶:');
        $this->command->info('  ÂèØÊêúÂ∞ã "john", "jane", "bob", "Áéã", "Êùé", "Èô≥" Á≠âÈóúÈçµÂ≠ó');
        $this->command->info('');
        
        $this->command->info('‚ö° Âø´ÈÄüÈáçÂª∫Êåá‰ª§:');
        $this->command->info('  php artisan db:seed --class=DevelopmentSeeder');
        $this->command->info('');
        
        $this->command->warn('‚ö†Ô∏è  Ë´ãÂú®ÁîüÁî¢Áí∞Â¢É‰∏≠‰øÆÊîπÈ†êË®≠ÂØÜÁ¢ºÔºÅ');
    }
}