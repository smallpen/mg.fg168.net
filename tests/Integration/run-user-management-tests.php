<?php

/**
 * ‰ΩøÁî®ËÄÖÁÆ°ÁêÜÊï¥ÂêàÊ∏¨Ë©¶Âü∑Ë°åËÖ≥Êú¨
 * 
 * ÈÄôÂÄãËÖ≥Êú¨Áî®ÊñºÂü∑Ë°åÊâÄÊúâ‰ΩøÁî®ËÄÖÁÆ°ÁêÜÁõ∏ÈóúÁöÑÊï¥ÂêàÊ∏¨Ë©¶
 * ÂåÖÂê´ÂäüËÉΩÊ∏¨Ë©¶„ÄÅÁÄèË¶ΩÂô®Ê∏¨Ë©¶ÂíåÊïàËÉΩÊ∏¨Ë©¶
 */

require_once __DIR__ . '/../../vendor/autoload.php';

class UserManagementTestRunner
{
    private array $testResults = [];
    private float $startTime;
    private string $reportPath;

    public function __construct()
    {
        $this->startTime = microtime(true);
        $this->reportPath = storage_path('logs/user-management-test-report-' . date('Y-m-d-H-i-s') . '.html');
    }

    /**
     * Âü∑Ë°åÊâÄÊúâÊï¥ÂêàÊ∏¨Ë©¶
     */
    public function runAllTests(): void
    {
        echo "üöÄ ÈñãÂßãÂü∑Ë°å‰ΩøÁî®ËÄÖÁÆ°ÁêÜÊï¥ÂêàÊ∏¨Ë©¶Â•ó‰ª∂\n";
        echo "=" . str_repeat("=", 50) . "\n\n";

        // 1. Âü∑Ë°åÂäüËÉΩÊï¥ÂêàÊ∏¨Ë©¶
        $this->runIntegrationTests();

        // 2. Âü∑Ë°åÊïàËÉΩÊ∏¨Ë©¶
        $this->runPerformanceTests();

        // 3. Âü∑Ë°åÁÄèË¶ΩÂô®Ê∏¨Ë©¶
        $this->runBrowserTests();

        // 4. ÁîüÊàêÊ∏¨Ë©¶Â†±Âëä
        $this->generateReport();

        echo "\n" . str_repeat("=", 52) . "\n";
        echo "‚úÖ ÊâÄÊúâÊ∏¨Ë©¶Âü∑Ë°åÂÆåÊàêÔºÅ\n";
        echo "üìä Ê∏¨Ë©¶Â†±ÂëäÂ∑≤ÁîüÊàêÔºö{$this->reportPath}\n";
        echo "‚è±Ô∏è  Á∏ΩÂü∑Ë°åÊôÇÈñìÔºö" . round(microtime(true) - $this->startTime, 2) . " Áßí\n";
    }

    /**
     * Âü∑Ë°åÂäüËÉΩÊï¥ÂêàÊ∏¨Ë©¶
     */
    private function runIntegrationTests(): void
    {
        echo "üìã Âü∑Ë°åÂäüËÉΩÊï¥ÂêàÊ∏¨Ë©¶...\n";
        
        $command = 'php artisan test tests/Feature/Integration/UserManagementIntegrationTest.php --verbose';
        $output = $this->executeCommand($command);
        
        $this->testResults['integration'] = [
            'name' => 'ÂäüËÉΩÊï¥ÂêàÊ∏¨Ë©¶',
            'command' => $command,
            'output' => $output,
            'status' => $this->parseTestStatus($output),
            'duration' => $this->parseTestDuration($output),
        ];

        echo $this->testResults['integration']['status'] === 'passed' ? "‚úÖ" : "‚ùå";
        echo " ÂäüËÉΩÊï¥ÂêàÊ∏¨Ë©¶ÂÆåÊàê\n\n";
    }

    /**
     * Âü∑Ë°åÊïàËÉΩÊ∏¨Ë©¶
     */
    private function runPerformanceTests(): void
    {
        echo "‚ö° Âü∑Ë°åÊïàËÉΩÊ∏¨Ë©¶...\n";
        
        $command = 'php artisan test tests/Feature/Performance/UserManagementPerformanceTest.php --verbose';
        $output = $this->executeCommand($command);
        
        $this->testResults['performance'] = [
            'name' => 'ÊïàËÉΩÊ∏¨Ë©¶',
            'command' => $command,
            'output' => $output,
            'status' => $this->parseTestStatus($output),
            'duration' => $this->parseTestDuration($output),
            'metrics' => $this->parsePerformanceMetrics($output),
        ];

        echo $this->testResults['performance']['status'] === 'passed' ? "‚úÖ" : "‚ùå";
        echo " ÊïàËÉΩÊ∏¨Ë©¶ÂÆåÊàê\n\n";
    }

    /**
     * Âü∑Ë°åÁÄèË¶ΩÂô®Ê∏¨Ë©¶
     */
    private function runBrowserTests(): void
    {
        echo "üåê Âü∑Ë°åÁÄèË¶ΩÂô®Ëá™ÂãïÂåñÊ∏¨Ë©¶...\n";
        
        // Ê™¢Êü•ÊòØÂê¶ÂÆâË£ù‰∫Ü Laravel Dusk
        if (!file_exists(base_path('vendor/laravel/dusk'))) {
            echo "‚ö†Ô∏è  Laravel Dusk Êú™ÂÆâË£ùÔºåË∑≥ÈÅéÁÄèË¶ΩÂô®Ê∏¨Ë©¶\n\n";
            $this->testResults['browser'] = [
                'name' => 'ÁÄèË¶ΩÂô®Ê∏¨Ë©¶',
                'status' => 'skipped',
                'reason' => 'Laravel Dusk Êú™ÂÆâË£ù',
            ];
            return;
        }

        $command = 'php artisan dusk tests/Browser/UserManagementBrowserTest.php --verbose';
        $output = $this->executeCommand($command);
        
        $this->testResults['browser'] = [
            'name' => 'ÁÄèË¶ΩÂô®Ëá™ÂãïÂåñÊ∏¨Ë©¶',
            'command' => $command,
            'output' => $output,
            'status' => $this->parseTestStatus($output),
            'duration' => $this->parseTestDuration($output),
        ];

        echo $this->testResults['browser']['status'] === 'passed' ? "‚úÖ" : "‚ùå";
        echo " ÁÄèË¶ΩÂô®Ê∏¨Ë©¶ÂÆåÊàê\n\n";
    }

    /**
     * Âü∑Ë°åÂëΩ‰ª§‰∏¶ËøîÂõûËº∏Âá∫
     */
    private function executeCommand(string $command): string
    {
        $startTime = microtime(true);
        
        ob_start();
        $returnCode = 0;
        passthru($command . ' 2>&1', $returnCode);
        $output = ob_get_clean();
        
        $duration = microtime(true) - $startTime;
        
        return $output . "\n\nÂü∑Ë°åÊôÇÈñì: " . round($duration, 2) . " Áßí\nËøîÂõûÁ¢º: " . $returnCode;
    }

    /**
     * Ëß£ÊûêÊ∏¨Ë©¶ÁãÄÊÖã
     */
    private function parseTestStatus(string $output): string
    {
        if (strpos($output, 'FAILURES!') !== false || strpos($output, 'ERRORS!') !== false) {
            return 'failed';
        } elseif (strpos($output, 'OK') !== false || strpos($output, 'Tests:') !== false) {
            return 'passed';
        } else {
            return 'unknown';
        }
    }

    /**
     * Ëß£ÊûêÊ∏¨Ë©¶Âü∑Ë°åÊôÇÈñì
     */
    private function parseTestDuration(string $output): ?float
    {
        if (preg_match('/Time: (\d+(?:\.\d+)?)\s*(?:seconds?|ms)/', $output, $matches)) {
            return (float) $matches[1];
        }
        return null;
    }

    /**
     * Ëß£ÊûêÊïàËÉΩÊåáÊ®ô
     */
    private function parsePerformanceMetrics(string $output): array
    {
        $metrics = [];
        
        // Ëß£ÊûêËºâÂÖ•ÊôÇÈñì
        if (preg_match('/È†ÅÈù¢ËºâÂÖ•ÊôÇÈñì.*?(\d+(?:\.\d+)?)\s*Áßí/', $output, $matches)) {
            $metrics['page_load_time'] = (float) $matches[1];
        }
        
        // Ëß£ÊûêÊêúÂ∞ãÈüøÊáâÊôÇÈñì
        if (preg_match('/ÊêúÂ∞ãÈüøÊáâÊôÇÈñì.*?(\d+(?:\.\d+)?)\s*Áßí/', $output, $matches)) {
            $metrics['search_response_time'] = (float) $matches[1];
        }
        
        // Ëß£ÊûêË®òÊÜ∂È´î‰ΩøÁî®Èáè
        if (preg_match('/Ë®òÊÜ∂È´î‰ΩøÁî®Èáè.*?(\d+(?:\.\d+)?)\s*MB/', $output, $matches)) {
            $metrics['memory_usage_mb'] = (float) $matches[1];
        }
        
        return $metrics;
    }

    /**
     * ÁîüÊàê HTML Ê∏¨Ë©¶Â†±Âëä
     */
    private function generateReport(): void
    {
        $totalDuration = microtime(true) - $this->startTime;
        $timestamp = date('Y-m-d H:i:s');
        
        $html = $this->generateReportHTML($timestamp, $totalDuration);
        
        // Á¢∫‰øùÁõÆÈåÑÂ≠òÂú®
        $reportDir = dirname($this->reportPath);
        if (!is_dir($reportDir)) {
            mkdir($reportDir, 0755, true);
        }
        
        file_put_contents($this->reportPath, $html);
    }

    /**
     * ÁîüÊàê HTML Â†±ÂëäÂÖßÂÆπ
     */
    private function generateReportHTML(string $timestamp, float $totalDuration): string
    {
        $passedCount = 0;
        $failedCount = 0;
        $skippedCount = 0;
        
        foreach ($this->testResults as $result) {
            switch ($result['status']) {
                case 'passed':
                    $passedCount++;
                    break;
                case 'failed':
                    $failedCount++;
                    break;
                case 'skipped':
                    $skippedCount++;
                    break;
            }
        }
        
        $overallStatus = $failedCount > 0 ? 'FAILED' : 'PASSED';
        $statusColor = $failedCount > 0 ? '#dc3545' : '#28a745';
        
        return <<<HTML
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ΩøÁî®ËÄÖÁÆ°ÁêÜÊï¥ÂêàÊ∏¨Ë©¶Â†±Âëä</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px 8px 0 0; }
        .header h1 { margin: 0; font-size: 2.5em; }
        .header .subtitle { margin: 10px 0 0 0; opacity: 0.9; }
        .summary { padding: 30px; border-bottom: 1px solid #eee; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .summary-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .summary-card h3 { margin: 0 0 10px 0; color: #495057; }
        .summary-card .number { font-size: 2em; font-weight: bold; color: #007bff; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; }
        .status-passed { background-color: #28a745; }
        .status-failed { background-color: #dc3545; }
        .status-skipped { background-color: #6c757d; }
        .test-results { padding: 30px; }
        .test-section { margin-bottom: 30px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .test-section-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6; }
        .test-section-content { padding: 20px; }
        .test-output { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .metrics-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .metrics-table th, .metrics-table td { padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .metrics-table th { background: #f8f9fa; font-weight: bold; }
        .footer { padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 8px 8px; text-align: center; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‰ΩøÁî®ËÄÖÁÆ°ÁêÜÊï¥ÂêàÊ∏¨Ë©¶Â†±Âëä</h1>
            <p class="subtitle">ÂÆåÊï¥ÁöÑÂäüËÉΩ„ÄÅÊïàËÉΩÂíåÁÄèË¶ΩÂô®Ê∏¨Ë©¶ÁµêÊûú</p>
        </div>
        
        <div class="summary">
            <h2>Ê∏¨Ë©¶ÊëòË¶Å</h2>
            <p><strong>Âü∑Ë°åÊôÇÈñìÔºö</strong> {$timestamp}</p>
            <p><strong>Á∏ΩÂü∑Ë°åÊôÇÈñìÔºö</strong> " . round($totalDuration, 2) . " Áßí</p>
            <p><strong>Êï¥È´îÁãÄÊÖãÔºö</strong> <span class="status-badge status-" . strtolower($overallStatus) . "\">{$overallStatus}</span></p>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>ÈÄöÈÅéÊ∏¨Ë©¶</h3>
                    <div class="number" style="color: #28a745;">{$passedCount}</div>
                </div>
                <div class="summary-card">
                    <h3>Â§±ÊïóÊ∏¨Ë©¶</h3>
                    <div class="number" style="color: #dc3545;">{$failedCount}</div>
                </div>
                <div class="summary-card">
                    <h3>Ë∑≥ÈÅéÊ∏¨Ë©¶</h3>
                    <div class="number" style="color: #6c757d;">{$skippedCount}</div>
                </div>
                <div class="summary-card">
                    <h3>Á∏ΩÊ∏¨Ë©¶Êï∏</h3>
                    <div class="number">" . count($this->testResults) . "</div>
                </div>
            </div>
        </div>
        
        <div class="test-results">
            <h2>Ë©≥Á¥∞Ê∏¨Ë©¶ÁµêÊûú</h2>
HTML;

        foreach ($this->testResults as $key => $result) {
            $statusClass = 'status-' . $result['status'];
            $statusText = strtoupper($result['status']);
            
            $html .= <<<HTML
            <div class="test-section">
                <div class="test-section-header">
                    <h3>{$result['name']} <span class="status-badge {$statusClass}">{$statusText}</span></h3>
                </div>
                <div class="test-section-content">
HTML;

            if (isset($result['command'])) {
                $html .= "<p><strong>Âü∑Ë°åÂëΩ‰ª§Ôºö</strong> <code>{$result['command']}</code></p>";
            }
            
            if (isset($result['duration'])) {
                $html .= "<p><strong>Âü∑Ë°åÊôÇÈñìÔºö</strong> " . round($result['duration'], 2) . " Áßí</p>";
            }
            
            if (isset($result['reason'])) {
                $html .= "<p><strong>Ë∑≥ÈÅéÂéüÂõ†Ôºö</strong> {$result['reason']}</p>";
            }
            
            if (isset($result['metrics']) && !empty($result['metrics'])) {
                $html .= "<h4>ÊïàËÉΩÊåáÊ®ô</h4>";
                $html .= "<table class=\"metrics-table\">";
                $html .= "<tr><th>ÊåáÊ®ô</th><th>Êï∏ÂÄº</th></tr>";
                
                foreach ($result['metrics'] as $metric => $value) {
                    $html .= "<tr><td>{$metric}</td><td>{$value}</td></tr>";
                }
                
                $html .= "</table>";
            }
            
            if (isset($result['output'])) {
                $html .= "<h4>Ê∏¨Ë©¶Ëº∏Âá∫</h4>";
                $html .= "<div class=\"test-output\">" . htmlspecialchars($result['output']) . "</div>";
            }
            
            $html .= "</div></div>";
        }

        $html .= <<<HTML
        </div>
        
        <div class="footer">
            <p>Ê≠§Â†±ÂëäÁî±‰ΩøÁî®ËÄÖÁÆ°ÁêÜÊï¥ÂêàÊ∏¨Ë©¶Â•ó‰ª∂Ëá™ÂãïÁîüÊàê</p>
            <p>ÁîüÊàêÊôÇÈñìÔºö{$timestamp}</p>
        </div>
    </div>
</body>
</html>
HTML;

        return $html;
    }
}

// Âü∑Ë°åÊ∏¨Ë©¶Â•ó‰ª∂
if (php_sapi_name() === 'cli') {
    $runner = new UserManagementTestRunner();
    $runner->runAllTests();
} else {
    echo "Ê≠§ËÖ≥Êú¨Âè™ËÉΩÂú®ÂëΩ‰ª§Âàó‰∏≠Âü∑Ë°å\n";
    exit(1);
}